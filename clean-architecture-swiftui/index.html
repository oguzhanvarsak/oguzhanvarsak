<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-96224610-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-96224610-1');
  </script>
	<meta charset="utf-8">
	<title>Clean Architecture for SwiftUI - Alexey Naumov</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Alexey Naumov" property="og:site_name">
  
    <meta content="Clean Architecture for SwiftUI" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="Are VIPER, RIBs, MVVM or VIP suitable for SwiftUI project?" property="og:description">
  
  
    <meta content="http://nalexn.github.io/clean-architecture-swiftui/" property="og:url">
  
  
    <meta content="2019-11-04T14:30:00+03:00" property="article:published_time">
    <meta content="http://nalexn.github.io/about/" property="article:author">
  
  
    <meta content="http://nalexn.github.io/assets/img/clean_swiftui_01.jpg" property="og:image">
  
  
    
  
  
    <meta name="keywords" content="iOS, swift, SwiftUI, Combine, design, pattern, redux, unidirectional, data, flow, best, practices">
    
    <meta content="iOS" property="article:tag">
    
    <meta content="swift" property="article:tag">
    
    <meta content="SwiftUI" property="article:tag">
    
    <meta content="Combine" property="article:tag">
    
    <meta content="design" property="article:tag">
    
    <meta content="pattern" property="article:tag">
    
    <meta content="redux" property="article:tag">
    
    <meta content="unidirectional" property="article:tag">
    
    <meta content="data" property="article:tag">
    
    <meta content="flow" property="article:tag">
    
    <meta content="best" property="article:tag">
    
    <meta content="practices" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@nallexn">
  
    <meta name="twitter:title" content="Clean Architecture for SwiftUI">
  
  
    <meta name="twitter:url" content="http://nalexn.github.io/clean-architecture-swiftui/">
  
  
    <meta name="twitter:description" content="Are VIPER, RIBs, MVVM or VIP suitable for SwiftUI project?">
  

	<meta name="description" content="Are VIPER, RIBs, MVVM or VIP suitable for SwiftUI project?">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
  <link rel="icon" sizes="16x16" href="/assets/img/favicon/favicon.ico">
  <link rel="icon" sizes="32x32" href="/assets/img/favicon/favicon-32.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicon/favicon-114.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css?v=2">
</head>

<body>
  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="author-logo">
      <span class="hover-message">Let's connect on LinkedIn!</span>
      <div class="cover-author-image">
        <a href="https://in.linkedin.com/in/nalexn" target="_blank"><img src="/assets/img/profile-image.jpg" alt="Alexey Naumov"></a>
      </div>
      </div>
      <div class="author-name">Alexey Naumov</div>
      <a href="/"><img src="/assets/img/content_00.png" alt="" style="-webkit-border-radius: 0%; border-radius: 0%;"></a>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Links</h3>
      <ul>
        <li><a href="https://twitter.com/nallexn" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        <li><a href="https://in.linkedin.com/in/nalexn" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a href="https://github.com/nalexn" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a href="https://stackoverflow.com/users/2923345?tab=profile" target="_blank"><i class="fa fa-stack-overflow" aria-hidden="true"></i></a></li>
        <li><a href="http://nalexn.github.io/feed.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2020 &copy; Alexey Naumov</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">Clean Architecture for SwiftUI</h1>
        <div class="page-date"><span>2019, Nov 04&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <div class="page-image"><img class="page-image" src=/assets/img/clean_swiftui_01.jpg alt="Clean Architecture for SwiftUI"></div>
      <p>Can you imagine, UIKit is 11 years old! Ever since the release of the iOS SDK in 2008 we were building our apps with it. And throughout this time the developers were in a relentless search for the best architecture to use for their apps. It all started with <strong>MVC</strong>, but later we witnessed the rise of <strong>MVP</strong>, <strong>MVVM</strong>, <strong>VIPER</strong>, <strong>RIBs</strong>, and <strong>VIP</strong>.</p>

<p>But something has happened recently. This “something” is so significant, that the majority of the architectural patterns used for iOS will soon become history.</p>

<p>I’m talking about SwiftUI. It’s not going anywhere. Like it or not, this is the future of iOS development. And it’s a game-changer in terms of the challenges we face when designing the architecture.</p>

<h1 id="what-are-the-conceptual-changes">What are the conceptual changes?</h1>

<p>UIKit was an object-oriented, event-driven framework. We could reference each view in the hierarchy, update it’s appearance when the view is loaded or as a reaction on an event (a touch-down on the button or a new data becoming available for display in UITableView). We used callbacks, delegates, target-actions for handling these events.</p>

<p>Now, it is all gone. SwiftUI is a declarative, state-driven framework. Event handling happens solely with closure callbacks, which offers higher cohesion for the business logic behind handling the input. So it has become easier to extract the business logic to an external module than it was with MVC: fixing “massive view” is a breeze compared to refactoring the “massive view controller”.</p>

<p>The view is dehydrated to be a programming function. You provide it with input (the state) - it draws the output. And there is no way to directly mutate the view or dynamically change the input sources once the view is created - it all has to be declared in the construction of the view.</p>

<div style="max-width:600px; display: block; margin-left: auto; margin-right: auto;"><img src="http://nalexn.github.io/assets/img/clean_swiftui_02.jpg" /></div>

<h1 id="mvvm-is-the-new-standard-architecture">MVVM is the new standard architecture</h1>

<p>SwiftUI comes with MVVM built-in. The attributes like <code class="language-plaintext highlighter-rouge">@Published</code> or <code class="language-plaintext highlighter-rouge">@State</code> allow us to bind the view with the state, while <code class="language-plaintext highlighter-rouge">@ObservableObject</code> can take the role of the ViewModel for encapsulation of the business logic and providing the bindable data.</p>

<p>MVVM is, in fact, the new standard architecture Apple has declared as a successor of MVC for SwiftUI:</p>

<div style="max-width:800px; display: block; margin-left: auto; margin-right: auto;"><img src="http://nalexn.github.io/assets/img/clean_swiftui_03.jpg" /></div>

<blockquote>
  <p>And well, you don’t need a ViewController anymore.</p>
</blockquote>

<p>So if you choose to design the architecture for your SwiftUI app in an MVVM style, you’d come up with something like this:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="c1">// Model</span>
<span class="kd">struct</span> <span class="kt">Country</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span>
<span class="p">}</span>

<span class="c1">// View</span>
<span class="kd">struct</span> <span class="kt">CountriesList</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    
    <span class="kd">@ObservedObject</span> <span class="k">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="kt">ViewModel</span>
    
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">List</span><span class="p">(</span><span class="n">viewModel</span><span class="o">.</span><span class="n">countries</span><span class="p">)</span> <span class="p">{</span> <span class="n">country</span> <span class="k">in</span>
            <span class="kt">Text</span><span class="p">(</span><span class="n">country</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="p">}</span><span class="o">.</span><span class="n">onAppear</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">viewModel</span><span class="o">.</span><span class="nf">loadCountries</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ViewModel</span>
<span class="kd">extension</span> <span class="kt">CountriesList</span> <span class="p">{</span>
    <span class="kd">class</span> <span class="kt">ViewModel</span><span class="p">:</span> <span class="kt">ObservableObject</span> <span class="p">{</span>
        <span class="kd">@Published</span> <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">countries</span><span class="p">:</span> <span class="p">[</span><span class="kt">Country</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="kd">private</span> <span class="k">let</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">WebService</span>
        
        <span class="kd">func</span> <span class="nf">loadCountries</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">service</span><span class="o">.</span><span class="n">getCountries</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">result</span> <span class="k">in</span>
                <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">countries</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">value</span> <span class="p">??</span> <span class="p">[]</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>When the View appears on the screen, the <code class="language-plaintext highlighter-rouge">onAppear</code> callback triggers the <code class="language-plaintext highlighter-rouge">viewModel.loadCountries()</code>, which ultimately pushes the updated list of countries through <code class="language-plaintext highlighter-rouge">@Published</code> variable. As simple as that.</p>

<h1 id="router-is-history">Router is history</h1>

<p>Router (aka Coordinator) was an essential part of VIPER, RIBs and MVVM-R architectures. Allocation of a separate module for screen navigation was well justified in UIKit apps – the direct routing from one ViewController to another led to their tight coupling, not to mention the coding hell of deep linking to a screen deeply inside the ViewController’s hierarchy.</p>

<p>Well, SwiftUI made Router needless.</p>

<p>Every view that alters the displayed hierarchy, be that <code class="language-plaintext highlighter-rouge">NavigationView</code>, <code class="language-plaintext highlighter-rouge">TabView</code> or <code class="language-plaintext highlighter-rouge">.sheet()</code>, now uses <code class="language-plaintext highlighter-rouge">Binding</code> to control what’s displayed.</p>

<p><code class="language-plaintext highlighter-rouge">Binding</code> is an “unpossessed” form of a state variable - you can read and write it, but the factual value belongs to another module.</p>

<p>When the user selects a tab in the <code class="language-plaintext highlighter-rouge">TabView</code>, you don’t get a callback. You simply cannot. What happens instead, is that the <code class="language-plaintext highlighter-rouge">TabView</code> unilaterally changes the value through <code class="language-plaintext highlighter-rouge">Binding</code> to “displayedTab = .userFavorites”.</p>

<p>The programmer can also assign a value to that <code class="language-plaintext highlighter-rouge">Binding</code> at any time - and the <code class="language-plaintext highlighter-rouge">TabView</code> will obey immediately.</p>

<p>The programmatic navigation in SwiftUI is fully controlled by the state through <code class="language-plaintext highlighter-rouge">Bindings</code>. I dedicated a <a href="http://nalexn.github.io/swiftui-deep-linking/">separate article</a> to this problem.</p>

<h1 id="are-viper-ribs-and-vip-applicable-for-swiftui">Are VIPER, RIBs and VIP applicable for SwiftUI?</h1>

<p>There are a lot of great ideas and concepts we can borrow from these architectures, but ultimately the canonical implementation of either one doesn’t make sense for the SwiftUI app.</p>

<p>First, as you already know, there is no more practical need to have a <code class="language-plaintext highlighter-rouge">Router</code>.</p>

<p>Secondly, the completely new design of the data flow in SwiftUI coupled with native support of view-state bindings shrank the required setup code to the degree that <code class="language-plaintext highlighter-rouge">Presenter</code> becomes a goofy entity doing nothing useful. Along with the decreased number of modules in the pattern, we figure out that we don’t need <code class="language-plaintext highlighter-rouge">Builder</code> either.</p>

<p>So basically, the whole pattern just falls apart, as the problems it aimed to solve don’t exist anymore.</p>

<p>There are <a href="https://theswiftdev.com/2019/09/18/how-to-build-swiftui-apps-using-viper/">attempts</a> to stick with the beloved architectures no matter what, but please, don’t.</p>

<h1 id="swiftui-is-conceptually-elm-architecture">SwiftUI is conceptually ELM Architecture</h1>

<p>Just watch a couple minutes from this talk “MCE 2017: Yasuhiro Inami, Elm Architecture in Swift” from 28:26</p>

<div style="position: relative; width: 100%; padding-bottom: 56.25%; height: 0;">
<iframe width="560" height="315" style="position: absolute; top:0; left: 0; width: 100%; height: 100%;" src="https://www.youtube.com/embed/U805TqsDIV8?start=1706" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
</div>

<p>That guy had a WORKING prototype of SwiftUI in 2017! Of course, since it was backed by UIKit it had terrible performance, but still!</p>

<p>Does it feel like we’re on a reality show where SwiftUI, a half-orphan kid, has just got to know who his father is?</p>

<p>Anyways, what interests us is whether we can use any other ELM concepts for making our SwiftUI apps better.</p>

<p>I followed the <a href="https://guide.elm-lang.org/architecture/">ELM Architecture</a> description on the ELM language’s web site and… found nothing new. SwiftUI is based on the same essences as ELM:</p>

<blockquote>
  <ul>
    <li>Model — the state of your application</li>
    <li>View — a way to turn your state into HTML</li>
    <li>Update — a way to update your state based on messages</li>
  </ul>
</blockquote>

<p>We saw this somewhere, didn’t we?</p>

<div style="max-width:600px; display: block; margin-left: auto; margin-right: auto;"><img src="http://nalexn.github.io/assets/img/clean_swiftui_04.jpg" /></div>

<p>We already have the <code class="language-plaintext highlighter-rouge">Model</code>, the <code class="language-plaintext highlighter-rouge">View</code> gets generated automatically from the <code class="language-plaintext highlighter-rouge">Model</code>, the only thing we can tweak is the way <code class="language-plaintext highlighter-rouge">Update</code> in delivered. We can go <strong>REDUX</strong> way and use the <code class="language-plaintext highlighter-rouge">Command</code> pattern for state mutation instead of letting SwiftUI’s views and other modules write to the state directly.
Although I preferred using REDUX in my previous UIKit projects (ReSwift ❤), it’s questionable whether it’s needed for a SwiftUI app — the data flows are already under control and are easily traceable.</p>

<h1 id="clean-architecture-again">Clean Architecture. Again</h1>

<p>Let’s not play the architect and just refer to the <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">Uncle Bob’s Clean Architecture</a>, the progenitor of VIP.</p>

<blockquote>
  <p>By separating the software into layers, and conforming to The Dependency Rule, you will create a system that is intrinsically testable, with all the benefits that imply.</p>
</blockquote>

<p>Clean Architecture is quite liberal about the number of layers we should introduce because this depends on the application domain.</p>

<p>But in the most common scenario for a mobile app we’ll need to have three layers:</p>

<ul>
  <li>Presentation layer</li>
  <li>Business Logic layer</li>
  <li>Data Access layer</li>
</ul>

<p>So if we distilled the requirements of the Clean Architecture through the peculiarity of SwiftUI, we’d come up with something like this:</p>

<div style="max-width:800px; display: block; margin-left: auto; margin-right: auto;"><img src="https://github.com/nalexn/blob_files/blob/master/images/swiftui_arc_001.png?raw=true" alt="Diagram" /></div>

<p>There is a <a href="https://github.com/nalexn/clean-architecture-swiftui">demo project</a> I’ve created to illustrate the use of this pattern. The app talks to the <a href="https://restcountries.eu/">restcountries.eu</a> REST API to show the list of countries and details about them.</p>

<h1 id="appstate">AppState</h1>

<p><code class="language-plaintext highlighter-rouge">AppState</code> is the only entity in the pattern that requires to be an object, specifically, an <code class="language-plaintext highlighter-rouge">ObservableObject</code>.</p>

<p>Works as the single source of truth and keeps the state for the entire app, including user’s data, authentication tokens, screen navigation state (selected tabs, presented sheets) and system state (is active / is backgrounded, etc.)</p>

<p>AppState knows nothing about any other layer and does not have any business logic.</p>

<p>An example of the <a href="https://github.com/nalexn/clean-architecture-swiftui/blob/master/CountriesSwiftUI/Injected/AppState.swift">AppState</a> from the Countries demo project:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">AppState</span><span class="p">:</span> <span class="kt">ObservableObject</span><span class="p">,</span> <span class="kt">Equatable</span> <span class="p">{</span>
    <span class="kd">@Published</span> <span class="k">var</span> <span class="nv">userData</span> <span class="o">=</span> <span class="kt">UserData</span><span class="p">()</span>
    <span class="kd">@Published</span> <span class="k">var</span> <span class="nv">routing</span> <span class="o">=</span> <span class="kt">ViewRouting</span><span class="p">()</span>
    <span class="kd">@Published</span> <span class="k">var</span> <span class="nv">system</span> <span class="o">=</span> <span class="kt">System</span><span class="p">()</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="view">View</h1>

<p>This is the usual SwiftUI’s view. It may be stateless or have local <code class="language-plaintext highlighter-rouge">@State</code> variables.</p>

<p>No other layers know about the View layer existence, so there is no need to hide it behind a protocol.</p>

<p>When the view is instantiated, it receives
<code class="language-plaintext highlighter-rouge">AppState</code> and <code class="language-plaintext highlighter-rouge">Interactor</code> through the SwiftUI’s standard dependency injection of a variable attributed with <code class="language-plaintext highlighter-rouge">@Environment</code>, <code class="language-plaintext highlighter-rouge">@EnvironmentObject</code> or <code class="language-plaintext highlighter-rouge">@ObservedObject</code>.</p>

<p>Side effects are triggered by the user’s actions (such as a tap on a button) or view lifecycle event <code class="language-plaintext highlighter-rouge">onAppear</code> and are forwarded to the <code class="language-plaintext highlighter-rouge">Interactor</code>.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">CountriesList</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    
    <span class="kd">@EnvironmentObject</span> <span class="k">var</span> <span class="nv">appState</span><span class="p">:</span> <span class="kt">AppState</span>
    <span class="kd">@Environment</span><span class="p">(\</span><span class="o">.</span><span class="n">interactors</span><span class="p">)</span> <span class="k">var</span> <span class="nv">interactors</span><span class="p">:</span> <span class="kt">InteractorsContainer</span>
    
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="o">...</span>
        <span class="o">.</span><span class="n">onAppear</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">interactors</span><span class="o">.</span><span class="n">countriesInteractor</span><span class="o">.</span><span class="nf">loadCountries</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="interactor">Interactor</h1>

<p><code class="language-plaintext highlighter-rouge">Interactor</code> encapsulates the business logic for the specific <code class="language-plaintext highlighter-rouge">View</code> or a group of views. Together with the <code class="language-plaintext highlighter-rouge">AppState</code> forms the Business Logic layer, that’s fully independent of the presentation and the external resources.</p>

<p>It is fully stateless and only refers to the <code class="language-plaintext highlighter-rouge">AppState</code> object, injected as a constructor parameter.</p>

<p>Interactors should be “facaded” with a protocol so that the <code class="language-plaintext highlighter-rouge">View</code> could talk to a mocked <code class="language-plaintext highlighter-rouge">Interactor</code> in tests.</p>

<p>Interactors receive requests to perform work, such as obtaining data from an external source or making computations, but they never return data back directly, such as in a closure.</p>

<p>Instead, they forward the result to the <code class="language-plaintext highlighter-rouge">AppState</code> or a <code class="language-plaintext highlighter-rouge">Binding</code> provided by the View.</p>

<p>The <code class="language-plaintext highlighter-rouge">Binding</code> is used when the result of work (the data) is owned locally by one View and does not belong to the central <code class="language-plaintext highlighter-rouge">AppState</code>, that is, it doesn’t need to be persisted or shared with other screens of the app.</p>

<p><a href="https://github.com/nalexn/clean-architecture-swiftui/blob/master/CountriesSwiftUI/Interactors/CountriesInteractor.swift">CountriesInteractor</a> from the demo project:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">CountriesInteractor</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">loadCountries</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">load</span><span class="p">(</span><span class="nv">countryDetails</span><span class="p">:</span> <span class="kt">Binding</span><span class="o">&lt;</span><span class="kt">Loadable</span><span class="o">&lt;</span><span class="kt">Country</span><span class="o">.</span><span class="kt">Details</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">country</span><span class="p">:</span> <span class="kt">Country</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">RealCountriesInteractor</span><span class="p">:</span> <span class="kt">CountriesInteractor</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">webRepository</span><span class="p">:</span> <span class="kt">CountriesWebRepository</span>
    <span class="k">let</span> <span class="nv">appState</span><span class="p">:</span> <span class="kt">AppState</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">webRepository</span><span class="p">:</span> <span class="kt">CountriesWebRepository</span><span class="p">,</span> <span class="nv">appState</span><span class="p">:</span> <span class="kt">AppState</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">webRepository</span> <span class="o">=</span> <span class="n">webRepository</span>
        <span class="k">self</span><span class="o">.</span><span class="n">appState</span> <span class="o">=</span> <span class="n">appState</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">loadCountries</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">appState</span><span class="o">.</span><span class="n">userData</span><span class="o">.</span><span class="n">countries</span> <span class="o">=</span> <span class="o">.</span><span class="nf">isLoading</span><span class="p">(</span><span class="nv">last</span><span class="p">:</span> <span class="n">appState</span><span class="o">.</span><span class="n">userData</span><span class="o">.</span><span class="n">countries</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">weak</span> <span class="k">var</span> <span class="nv">weakAppState</span> <span class="o">=</span> <span class="n">appState</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">webRepository</span><span class="o">.</span><span class="nf">loadCountries</span><span class="p">()</span>
            <span class="o">.</span><span class="n">sinkToLoadable</span> <span class="p">{</span> <span class="n">weakAppState</span><span class="p">?</span><span class="o">.</span><span class="n">userData</span><span class="o">.</span><span class="n">countries</span> <span class="o">=</span> <span class="nv">$0</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">load</span><span class="p">(</span><span class="nv">countryDetails</span><span class="p">:</span> <span class="kt">Binding</span><span class="o">&lt;</span><span class="kt">Loadable</span><span class="o">&lt;</span><span class="kt">Country</span><span class="o">.</span><span class="kt">Details</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">country</span><span class="p">:</span> <span class="kt">Country</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">countryDetails</span><span class="o">.</span><span class="n">wrappedValue</span> <span class="o">=</span> <span class="o">.</span><span class="nf">isLoading</span><span class="p">(</span><span class="nv">last</span><span class="p">:</span> <span class="n">countryDetails</span><span class="o">.</span><span class="n">wrappedValue</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">webRepository</span><span class="o">.</span><span class="nf">loadCountryDetails</span><span class="p">(</span><span class="nv">country</span><span class="p">:</span> <span class="n">country</span><span class="p">)</span>
            <span class="o">.</span><span class="n">sinkToLoadable</span> <span class="p">{</span> <span class="n">countryDetails</span><span class="o">.</span><span class="n">wrappedValue</span> <span class="o">=</span> <span class="nv">$0</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="repository">Repository</h1>

<p><code class="language-plaintext highlighter-rouge">Repository</code> is an abstract gateway for reading / writing data.
Provides access to a single data service, be that a web server or a local database.</p>

<p>For example, if the app is using its backend, Google Maps APIs and writes something to a local database, there will be three Repositories: two for different web API providers and one for database IO operations.</p>

<p>The repository is also stateless, doesn’t have write access to the <code class="language-plaintext highlighter-rouge">AppState</code>, contains only the logic related to working with the data. It knows nothing about <code class="language-plaintext highlighter-rouge">View</code> or <code class="language-plaintext highlighter-rouge">Interactor</code>.</p>

<p>The factual Repository should be hidden behind a protocol so that the <code class="language-plaintext highlighter-rouge">Interactor</code> could talk to a mocked <code class="language-plaintext highlighter-rouge">Repository</code> in tests.</p>

<p><a href="https://github.com/nalexn/clean-architecture-swiftui/blob/master/CountriesSwiftUI/Repositories/CountriesWebRepository.swift">CountriesWebRepository</a> from the demo project:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre>
<span class="kd">protocol</span> <span class="kt">CountriesWebRepository</span><span class="p">:</span> <span class="kt">WebRepository</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">loadCountries</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Country</span><span class="p">],</span> <span class="kt">Error</span><span class="o">&gt;</span>
    <span class="kd">func</span> <span class="nf">loadCountryDetails</span><span class="p">(</span><span class="nv">country</span><span class="p">:</span> <span class="kt">Country</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Country</span><span class="o">.</span><span class="kt">Details</span><span class="o">.</span><span class="kt">Intermediate</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">RealCountriesWebRepository</span><span class="p">:</span> <span class="kt">CountriesWebRepository</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span>
    <span class="k">let</span> <span class="nv">baseURL</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">bgQueue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"bg_parse_queue"</span><span class="p">)</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">baseURL</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="k">self</span><span class="o">.</span><span class="n">baseURL</span> <span class="o">=</span> <span class="n">baseURL</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">loadCountries</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Country</span><span class="p">],</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">call</span><span class="p">(</span><span class="nv">endpoint</span><span class="p">:</span> <span class="kt">API</span><span class="o">.</span><span class="n">allCountries</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">loadCountryDetails</span><span class="p">(</span><span class="nv">country</span><span class="p">:</span> <span class="kt">Country</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Country</span><span class="o">.</span><span class="kt">Details</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">call</span><span class="p">(</span><span class="nv">endpoint</span><span class="p">:</span> <span class="kt">API</span><span class="o">.</span><span class="nf">countryDetails</span><span class="p">(</span><span class="n">country</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">RealCountriesWebRepository</span> <span class="p">{</span>
    <span class="kd">enum</span> <span class="kt">API</span><span class="p">:</span> <span class="kt">APICall</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">allCountries</span>
        <span class="k">case</span> <span class="nf">countryDetails</span><span class="p">(</span><span class="kt">Country</span><span class="p">)</span>
        
        <span class="k">var</span> <span class="nv">path</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
        <span class="k">var</span> <span class="nv">httpMethod</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
        <span class="k">var</span> <span class="nv">headers</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Since WebRepository takes URLSession as a constructor parameter, it is very easy to test it by <a href="https://github.com/nalexn/clean-architecture-swiftui/blob/master/UnitTests/Mocks/RequestMocking.swift">mocking the networking calls</a> with a custom <code class="language-plaintext highlighter-rouge">URLProtocol</code></p>

<h1 id="final-thoughts">Final thoughts</h1>

<p><a href="https://github.com/nalexn/clean-architecture-swiftui">The demo project</a> now has <strong>97% test coverage</strong>, all thanks to the Clean Architecture’s “dependency rule” and segregation of the app on multiple layers.</p>

<div style="max-width:800px; display: block; margin-left: auto; margin-right: auto;"><img src="https://github.com/nalexn/blob_files/blob/master/images/countries_preview.png?raw=true" alt="Diagram" /></div>

<p>I’m planning a separate article for a detailed explanation of the technical design desitions made during its development, as well as numerous “gotchas!” I had with SwiftUI. Make sure to follow me on <a href="https://twitter.com/nallexn">Twitter</a>!</p>

<p>Shall we assign a name to this architecture? Something like “VIRS”? Propose your variant in the comments!</p>

      <h2>Your appreciation is my inspiration!</h2>
      <p>I have tons of unpublished kick-ass materials and ideas, but I need your help! Consider sharing this article on <a href="https://twitter.com/share?url=http://nalexn.github.io/clean-architecture-swiftui/?utm_source=share_tw&amp;text=Clean Architecture for SwiftUI&amp;hashtags=iosdev&amp;via=nallexn" title="Twitter" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-twitter share-button"></i></a>, <a href="https://www.facebook.com/sharer/sharer.php?u=http://nalexn.github.io/clean-architecture-swiftui/?utm_source=share_fb&amp;display=popup&amp;quote=Clean Architecture for SwiftUI&amp;hashtag=#iosdev" title="Facebook" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-facebook-f share-button"></i></a> or <a href="https://www.linkedin.com/sharing/share-offsite/?url=http://nalexn.github.io/clean-architecture-swiftui/?utm_source=share_in" title="LinkedIn" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-linkedin share-button"></i></a>. This tiny action helps to grow this blog and inspires me to post more! (Or if you are nuts, <a href="https://venmo.com/nallexn" target="_blank">Venmo</a> me a drink!)</p>
      </p>
      <p>You can subscribe to <a href="http://nalexn.github.io/feed.xml" target="_blank">RSS feed</a> or follow my <a href="https://twitter.com/nallexn" target="_blank">Twitter</a> for the new articles alerts.

      <div style="width:0px; height:30px; display: block;"></div>
      <h2>Most recent articles</h2>
      <div class="content-box recent clearfix" style="padding: 20px 10px;">
        
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/layers_001.jpg)" href="/separation-of-concerns/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/separation-of-concerns/">Separation of Concerns in Software Design</a></h2>
              <p></p>
              <span class="post-date">2020, Jan 16&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">10 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/observable_001.jpg)" href="/swiftui-observableobject/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/swiftui-observableobject/">Why I quit using the ObservableObject</a></h2>
              <p></p>
              <span class="post-date">2019, Dec 20&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">7 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/comparison_01.jpg)" href="/anyview-vs-group/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/anyview-vs-group/">Performance Battle: AnyView vs Group</a></h2>
              <p></p>
              <span class="post-date">2019, Dec 05&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">9 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/swiftui_unit_testing_01.jpg)" href="/swiftui-unit-testing/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/swiftui-unit-testing/">Who said we cannot unit test SwiftUI views?</a></h2>
              <p></p>
              <span class="post-date">2019, Nov 21&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">12 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/deep_link_swiftui_01.jpg)" href="/swiftui-deep-linking/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/swiftui-deep-linking/">Programmatic navigation in SwiftUI project</a></h2>
              <p></p>
              <span class="post-date">2019, Nov 08&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">7 minute read</span>
            </div>
          </article>
          
        
        <article class="post">
          <a class="post-thumbnail" style="background-image: url(/assets/img/launch_001.jpg)" href="/"></a>
          <div class="post-content">
            <h2 class="post-title"><a href="/">Browse All Articles</a></h2>
            <p></p>
            <span class="post-date">Top iOS programming stuff, no kidding!</span>
          </div>
        </article>
      </div>
    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
</body>
</html>
