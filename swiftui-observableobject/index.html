<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-96224610-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-96224610-1');
  </script>
	<meta charset="utf-8">
	<title>Why I quit using the ObservableObject - Alexey Naumov</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Alexey Naumov" property="og:site_name">
  
    <meta content="Why I quit using the ObservableObject" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="There is a better option for Redux-style state-managed apps." property="og:description">
  
  
    <meta content="http://nalexn.github.io/swiftui-observableobject/" property="og:url">
  
  
    <meta content="2019-12-20T08:30:00+03:00" property="article:published_time">
    <meta content="http://nalexn.github.io/about/" property="article:author">
  
  
    <meta content="http://nalexn.github.io/assets/img/observable_001.jpg" property="og:image">
  
  
    
  
  
    <meta name="keywords" content="iOS, Swift, SwiftUI, Combine, Redux, Publisher, ObservedObject, EnvironmentObject, Snapshot, EquatableView, objectWillChange">
    
    <meta content="iOS" property="article:tag">
    
    <meta content="Swift" property="article:tag">
    
    <meta content="SwiftUI" property="article:tag">
    
    <meta content="Combine" property="article:tag">
    
    <meta content="Redux" property="article:tag">
    
    <meta content="Publisher" property="article:tag">
    
    <meta content="ObservedObject" property="article:tag">
    
    <meta content="EnvironmentObject" property="article:tag">
    
    <meta content="Snapshot" property="article:tag">
    
    <meta content="EquatableView" property="article:tag">
    
    <meta content="objectWillChange" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@nallexn">
  
    <meta name="twitter:title" content="Why I quit using the ObservableObject">
  
  
    <meta name="twitter:url" content="http://nalexn.github.io/swiftui-observableobject/">
  
  
    <meta name="twitter:description" content="There is a better option for Redux-style state-managed apps.">
  

	<meta name="description" content="There is a better option for Redux-style state-managed apps.">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
  <link rel="icon" sizes="16x16" href="/assets/img/favicon/favicon.ico">
  <link rel="icon" sizes="32x32" href="/assets/img/favicon/favicon-32.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicon/favicon-114.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css?v=2">
</head>

<body>
  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="author-logo">
      <span class="hover-message">Let's connect on LinkedIn!</span>
      <div class="cover-author-image">
        <a href="https://in.linkedin.com/in/nalexn" target="_blank"><img src="/assets/img/profile-image.jpg" alt="Alexey Naumov"></a>
      </div>
      </div>
      <div class="author-name">Alexey Naumov</div>
      <a href="/"><img src="/assets/img/content_00.png" alt="" style="-webkit-border-radius: 0%; border-radius: 0%;"></a>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Links</h3>
      <ul>
        <li><a href="https://twitter.com/nallexn" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        <li><a href="https://in.linkedin.com/in/nalexn" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a href="https://github.com/nalexn" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a href="https://stackoverflow.com/users/2923345?tab=profile" target="_blank"><i class="fa fa-stack-overflow" aria-hidden="true"></i></a></li>
        <li><a href="http://nalexn.github.io/feed.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2020 &copy; Alexey Naumov</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">Why I quit using the ObservableObject</h1>
        <div class="page-date"><span>2019, Dec 20&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <div class="page-image"><img class="page-image" src=/assets/img/observable_001.jpg alt="Why I quit using the ObservableObject"></div>
      <p>“Single source of truth” has become a buzzword in the iOS community after WWDC 2019 <a href="https://developer.apple.com/videos/play/wwdc2019/226/">Data Flow Through SwiftUI</a> session.</p>

<p>SwiftUI framework was designed to encourage building the apps in the single-source-of-truth style, be that Redux-like centralized app state or ViewModels serving the data only to their views.</p>

<p>It feels natural to use <code class="language-plaintext highlighter-rouge">@ObservedObject</code> or <code class="language-plaintext highlighter-rouge">@EnvironmentObject</code> for the state management of such views, as the <code class="language-plaintext highlighter-rouge">ObservableObjects</code> fit the design really well.</p>

<p>But there is a little problem.</p>

<p>As I’ve been <a href="https://nalexn.github.io/anyview-vs-group/?utm_source=medium_flawless">exploring</a> how SwiftUI works under high load, I discovered severe degrade of the performance proportional to the number of views being subscribed on the state update.</p>

<p>We can have a couple of thousands of views on the screen with just one being subscribed - the update is rendered lightning-fast, even for a view deep inside the hierarchy.</p>

<p>But it’s sufficient to have just a few hundreds of views <strong>subscribed</strong> on the same update (and not being factually changed) - and you’ll notice a significant performance drawdown.</p>

<p>This means if we’re building a large SwiftUI app based on a Redux-like centralized state, we’re likely to be in big trouble!</p>

<h2 id="wrapping-every-view-in-equatableview">Wrapping every view in EquatableView</h2>

<p>At first glance, <code class="language-plaintext highlighter-rouge">EquatableView</code> looks like the perfect candidate for solving this problem.</p>

<p>It allows for writing a custom diffing strategy for the views, specifically, comparing the state instead of comparing the <code class="language-plaintext highlighter-rouge">body</code>.</p>

<p>But even if the <a href="https://swiftui-lab.com/equatableview/">mystical undocumented behavior</a> of <code class="language-plaintext highlighter-rouge">EquatableView</code> is addressed someday in the future, we still won’t be able to compare views that reference mutating state objects, such as <code class="language-plaintext highlighter-rouge">EnvironmentObject</code> or <code class="language-plaintext highlighter-rouge">ObservedObject</code>.</p>

<p>Let me explain why. Consider this simple example:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">AppState</span><span class="p">:</span> <span class="kt">ObservableObject</span> <span class="p">{</span>
    <span class="kd">@Published</span> <span class="k">var</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">CustomView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@EnvironmentObject</span> <span class="k">var</span> <span class="nv">appState</span><span class="p">:</span> <span class="kt">AppState</span>
    
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">Text</span><span class="p">(</span><span class="s">"Value: </span><span class="se">\(</span><span class="n">appState</span><span class="o">.</span><span class="n">value</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>We’re opting out of the default SwiftUI diffing strategy by conforming to <code class="language-plaintext highlighter-rouge">Equatable</code>:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">CustomView</span><span class="p">:</span> <span class="kt">Equatable</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="o">==</span> <span class="p">(</span><span class="nv">lhs</span><span class="p">:</span> <span class="k">Self</span><span class="p">,</span> <span class="nv">rhs</span><span class="p">:</span> <span class="k">Self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">lhs</span><span class="o">.</span><span class="n">appState</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">appState</span><span class="o">.</span><span class="n">value</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>…and wrapping the view in <code class="language-plaintext highlighter-rouge">EquatableView</code>:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">CustomView</span><span class="p">()</span><span class="o">.</span><span class="nf">equatable</span><span class="p">()</span><span class="o">.</span><span class="nf">environmentObject</span><span class="p">(</span><span class="kt">AppState</span><span class="p">())</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now everything should be good, right?</p>

<p>You run the code and see that things got only worse:
now the view freezes in its initial state and never gets redrawn.</p>

<p>So, what’s going on?</p>

<p>While <code class="language-plaintext highlighter-rouge">lhs</code> and <code class="language-plaintext highlighter-rouge">rhs</code> are two distinct instances of the <code class="language-plaintext highlighter-rouge">CustomView</code> struct, both copies are referencing the same shared object.</p>

<p>Because <code class="language-plaintext highlighter-rouge">AppState</code> is a <a href="https://developer.apple.com/swift/blog/?id=10">reference type</a>, SwiftUI won’t copy it upon mutation, so you’re basically comparing object instance to itself.</p>

<p>The <code class="language-plaintext highlighter-rouge">==</code> func always returns <code class="language-plaintext highlighter-rouge">true</code>, telling SwiftUI that our view does not require re-calculation. Never.</p>

<h2 id="snapshotting-the-state-in-the-view">Snapshotting the state in the view</h2>

<p>Ok, since we cannot rely on comparing references to the <code class="language-plaintext highlighter-rouge">ObservableObjects</code>, how about storing the snapshot of the previous state in the view when it receives an update?</p>

<p>Something like this:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">CustomView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@EnvironmentObject</span> <span class="k">var</span> <span class="nv">appState</span><span class="p">:</span> <span class="kt">AppState</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">prevValue</span><span class="p">:</span> <span class="kt">Int</span>
    
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">prevValue</span> <span class="o">=</span> <span class="n">appState</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="kt">Text</span><span class="p">(</span><span class="s">"Value: </span><span class="se">\(</span><span class="n">appState</span><span class="o">.</span><span class="n">value</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">CustomView</span><span class="p">:</span> <span class="kt">Equatable</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="o">==</span> <span class="p">(</span><span class="nv">lhs</span><span class="p">:</span> <span class="k">Self</span><span class="p">,</span> <span class="nv">rhs</span><span class="p">:</span> <span class="k">Self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">lhs</span><span class="o">.</span><span class="n">prevValue</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">appState</span><span class="o">.</span><span class="n">value</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>In the <code class="language-plaintext highlighter-rouge">==</code> func we are comparing the <code class="language-plaintext highlighter-rouge">prevValue</code> to the updated <code class="language-plaintext highlighter-rouge">appState.value</code>, so this should work fine…</p>

<p>But it doesn’t. The reason - this simply won’t compile. <code class="language-plaintext highlighter-rouge">body</code> is immutable, so we’re not allowed to set <code class="language-plaintext highlighter-rouge">prevValue</code> in it.</p>

<p>There is a workaround to this problem - we can create a reference type wrapper for storing the <code class="language-plaintext highlighter-rouge">prevValue</code>, but this all starts to be really cumbersome and smelly. In addition to that, the <code class="language-plaintext highlighter-rouge">==</code> func is <a href="https://swiftui-lab.com/equatableview/">not always called</a>, making this approach worthless.</p>

<p>How about something more elegant?</p>

<h2 id="filtering-the-state-updates">Filtering the state updates</h2>

<p>Prior to the release of SwiftUI and Combine frameworks I had a chance to try Redux state management on a large-scale UIKit app, and the combination of <a href="https://github.com/ReSwift/ReSwift">ReSwift</a> with <a href="https://github.com/ReactiveX/RxSwift">RxSwift</a> worked really well.</p>

<p>The problem of massive state updates was not so apparent, but I still used filtering of the updates in the pipeline to reduce the load:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kt">BehaviorRelay</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="kt">AppState</span><span class="p">())</span> <span class="c1">// produces all state updates</span>
    <span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value1</span> <span class="p">}</span> <span class="c1">// removing all unused state values</span>
    <span class="o">.</span><span class="nf">distinctUntilChanged</span><span class="p">()</span> <span class="c1">// remove duplicated "value1"</span>
    <span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="o">...</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>There is a function <code class="language-plaintext highlighter-rouge">distinctUntilChanged</code> is RxSwift (aka <code class="language-plaintext highlighter-rouge">skipRepeats</code> in ReactiveSwift and <code class="language-plaintext highlighter-rouge">removeDuplicates</code> in Combine) that allows for dropping the unnecessary update events when neither of the values used in the specific view got changed.</p>

<p>This approach would work for SwiftUI as well, but data bindings produced by <code class="language-plaintext highlighter-rouge">@State</code>, <code class="language-plaintext highlighter-rouge">@ObservedObject</code> and <code class="language-plaintext highlighter-rouge">@EnvironmentObject</code> don’t have this filtering functionality.</p>

<p>To me, it was surprising that <code class="language-plaintext highlighter-rouge">Publisher</code> from Combine is incompatible with <code class="language-plaintext highlighter-rouge">Binding</code> from SwiftUI, and there are literally just a couple of weird ways to connect them.</p>

<h2 id="wrapping-the-observableobject-in-observableobject">Wrapping the ObservableObject in ObservableObject</h2>

<div style="max-width:500px; display: block; margin-left: auto; margin-right: auto;"><img src="http://nalexn.github.io/assets/img/xzibit_01.png" /></div>

<p>If we want to stick with the <code class="language-plaintext highlighter-rouge">ObservableObject</code>, there is literally no way to skip an event from the inner <code class="language-plaintext highlighter-rouge">objectWillChange</code> publisher, because SwiftUI subscribes to it directly.</p>

<p>What we can do is to wrap the <code class="language-plaintext highlighter-rouge">ObservableObject</code> in another <code class="language-plaintext highlighter-rouge">ObservableObject</code> that does the filtering under the hood.</p>

<p>We can make this wrapper generic and highly reusable. <code class="language-plaintext highlighter-rouge">@dynamicMemberLookup</code> attribute allows the client code to interact with the wrapper just like with the genuine object.</p>

<p>You can find the implementation of <code class="language-plaintext highlighter-rouge">Deduplicated</code> on Github <a href="https://gist.github.com/nalexn/ace9ddd07db5a6e150163712e20c6235">gist</a>, but here is the conceptual part:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">object</span><span class="o">.</span><span class="n">objectWillChange</span>
    <span class="o">.</span><span class="nf">delay</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="o">.</span><span class="nf">nanoseconds</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nv">scheduler</span><span class="p">:</span> <span class="kt">RunLoop</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
    <span class="o">.</span><span class="n">compactMap</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span> <span class="nf">makeSnapshot</span><span class="p">()</span> <span class="p">}</span>
    <span class="o">.</span><span class="nf">prepend</span><span class="p">(</span><span class="nf">makeSnapshot</span><span class="p">())</span>
    <span class="o">.</span><span class="nf">removeDuplicates</span><span class="p">()</span>
    <span class="o">.</span><span class="nf">dropFirst</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">_</span> <span class="k">in</span>
        <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">objectWillChange</span><span class="o">.</span><span class="nf">send</span><span class="p">()</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>It is observing the <code class="language-plaintext highlighter-rouge">objectWillChange</code> of the original object, takes the snapshot of <code class="language-plaintext highlighter-rouge">AppState</code> by only including the values used in the specific view and then removes the duplicated values. In the end, if the snapshot is different than the previous one, it triggers <code class="language-plaintext highlighter-rouge">objectWillChange</code> on the wrapper object used by the view.</p>

<p>On the consumer’s side, what we had:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">CustomView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@EnvironmentObject</span> <span class="k">var</span> <span class="nv">appState</span><span class="p">:</span> <span class="kt">AppState</span>
    
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">Text</span><span class="p">(</span><span class="s">"Value: </span><span class="se">\(</span><span class="n">appState</span><span class="o">.</span><span class="n">value</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">view</span> <span class="o">=</span> <span class="kt">CustomView</span><span class="p">()</span>
    <span class="o">.</span><span class="nf">environmentObject</span><span class="p">(</span><span class="n">appState</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>…can be reworked in this manner:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">CustomView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@EnvironmentObject</span> <span class="k">var</span> <span class="nv">appState</span><span class="p">:</span> <span class="kt">Deduplicated</span><span class="o">&lt;</span><span class="kt">AppState</span><span class="p">,</span> <span class="kt">Snapshot</span><span class="o">&gt;</span>
    
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">Text</span><span class="p">(</span><span class="s">"Value: </span><span class="se">\(</span><span class="n">appState</span><span class="o">.</span><span class="n">value</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">view</span> <span class="o">=</span> <span class="kt">CustomView</span><span class="p">()</span>
    <span class="o">.</span><span class="nf">environmentObject</span><span class="p">(</span><span class="n">appState</span>
        <span class="o">.</span><span class="n">deduplicated</span> <span class="p">{</span> <span class="kt">Snapshot</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="p">})</span>
        
<span class="kd">extension</span> <span class="kt">CustomView</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">Snapshot</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>And that’s it! Now <code class="language-plaintext highlighter-rouge">AppState</code> can generate tons of updates, but only the ones containing different <code class="language-plaintext highlighter-rouge">.value</code> will be forwarded to the view.</p>

<p>I should note two downsides of this approach:</p>

<ol>
  <li>State update is delivered asynchronously due to the <code class="language-plaintext highlighter-rouge">.delay</code> call. This could be a gate for numerous bugs related to race conditions, but we’re not in UIKit. If another update comes out of the blue, the view will just get re-calculated twice and end up reflecting the most recent state values.</li>
  <li>The <code class="language-plaintext highlighter-rouge">Snapshot</code> type must be unique for each screen consuming <code class="language-plaintext highlighter-rouge">Deduplicated</code> as an <code class="language-plaintext highlighter-rouge">@EnvironmentObject</code>. This is required because otherwise there might be a conflict when injecting multiple objects with <code class="language-plaintext highlighter-rouge">.environmentObject(_:)</code> modifiers.</li>
</ol>

<h2 id="using-publisher-instead-of-the-observableobject">Using Publisher instead of the ObservableObject</h2>

<p>You know what, I’ve had enough of <code class="language-plaintext highlighter-rouge">ObservableObject</code>!</p>

<p>Seriously, the currently available API for <code class="language-plaintext highlighter-rouge">Binding</code> provides absolutely no control over the values flow.</p>

<p>You constantly need to bridge between it and Publishers from Combine, which are naturally used for networking and other asynchronous business logic.</p>

<p>I cannot see any use case where <code class="language-plaintext highlighter-rouge">@ObservedObject</code> or <code class="language-plaintext highlighter-rouge">@EnvironmentObject</code> would outpace the solution I’m about to propose when dealing with a centralized app state.</p>

<p>Let’s dive in:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">ContentView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    
    <span class="c1">// The local view's state encapsulated in one container:</span>
    <span class="kd">@State</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">state</span> <span class="o">=</span> <span class="kt">ViewState</span><span class="p">()</span>
    
    <span class="c1">// The app's state injection</span>
    <span class="kd">@Environment</span><span class="p">(\</span><span class="o">.</span><span class="n">injected</span><span class="p">)</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">injected</span><span class="p">:</span> <span class="kt">AppState</span><span class="o">.</span><span class="kt">Injection</span>
    
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">Text</span><span class="p">(</span><span class="s">"Value: </span><span class="se">\(</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">onReceive</span><span class="p">(</span><span class="n">stateUpdate</span><span class="p">)</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="nv">$0</span> <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// The state update filtering</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">stateUpdate</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">ViewState</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">injected</span><span class="o">.</span><span class="n">appState</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">viewState</span> <span class="p">}</span>
            <span class="o">.</span><span class="nf">removeDuplicates</span><span class="p">()</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Container for the local view state encapsulation</span>
<span class="kd">private</span> <span class="kd">extension</span> <span class="kt">ContentView</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">ViewState</span><span class="p">:</span> <span class="kt">Equatable</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Convenient mapping from AppState to ViewState</span>
<span class="kd">private</span> <span class="kd">extension</span> <span class="kt">AppState</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">viewState</span><span class="p">:</span> <span class="kt">ContentView</span><span class="o">.</span><span class="kt">ViewState</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="n">value1</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This approach has many benefits:</p>

<ol>
  <li>We’re not only filtering the updates but also limiting the access to the values defined in the local <code class="language-plaintext highlighter-rouge">ViewState</code> struct.</li>
  <li>We still benefit from using the native dependency injection with <code class="language-plaintext highlighter-rouge">@Environment</code> being used instead of <code class="language-plaintext highlighter-rouge">@EnvironmentObject</code>.</li>
  <li>The same <code class="language-plaintext highlighter-rouge">injected</code> container can be extended for injecting services.</li>
  <li>The updates are delivered synchronously.</li>
  <li>The code is more concise and clear than before.</li>
  <li>Easily scalable. No need to update the root dependency injection when adding a new view.</li>
</ol>

<p>Just to complete the example with the full code, here is the <code class="language-plaintext highlighter-rouge">AppState</code> and its injection:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">AppState</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">value1</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">var</span> <span class="nv">value2</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">var</span> <span class="nv">value3</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">AppState</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">Injection</span><span class="p">:</span> <span class="kt">EnvironmentKey</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">appState</span><span class="p">:</span> <span class="kt">CurrentValueSubject</span><span class="o">&lt;</span><span class="kt">AppState</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span>
        <span class="kd">static</span> <span class="k">var</span> <span class="nv">defaultValue</span><span class="p">:</span> <span class="k">Self</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">appState</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="kt">AppState</span><span class="p">()))</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">EnvironmentValues</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">injected</span><span class="p">:</span> <span class="kt">AppState</span><span class="o">.</span><span class="kt">Injection</span> <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">self</span><span class="p">[</span><span class="kt">AppState</span><span class="o">.</span><span class="kt">Injection</span><span class="o">.</span><span class="k">self</span><span class="p">]</span> <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span> <span class="k">self</span><span class="p">[</span><span class="kt">AppState</span><span class="o">.</span><span class="kt">Injection</span><span class="o">.</span><span class="k">self</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValue</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">injected</span> <span class="o">=</span> <span class="kt">AppState</span><span class="o">.</span><span class="kt">Injection</span><span class="p">(</span><span class="nv">appState</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="kt">AppState</span><span class="p">()))</span>
<span class="k">let</span> <span class="nv">contentView</span> <span class="o">=</span> <span class="kt">ContentView</span><span class="p">()</span><span class="o">.</span><span class="nf">environment</span><span class="p">(\</span><span class="o">.</span><span class="n">injected</span><span class="p">,</span> <span class="n">injected</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I’ve tried several ways to implement the reversed data flow from the standard SwiftUI views back to the <code class="language-plaintext highlighter-rouge">AppState</code>. The one that finally worked well was wrapping the <code class="language-plaintext highlighter-rouge">Binding</code> submitted to the SwiftUI’s view into the middleware that forwards the values to the <code class="language-plaintext highlighter-rouge">AppState</code>:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">Binding</span> <span class="k">where</span> <span class="kt">Value</span><span class="p">:</span> <span class="kt">Equatable</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">dispatched</span><span class="p">(</span><span class="n">to</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">CurrentValueSubject</span><span class="o">&lt;</span><span class="kt">AppState</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">,</span>
                    <span class="n">_</span> <span class="nv">keyPath</span><span class="p">:</span> <span class="kt">WritableKeyPath</span><span class="o">&lt;</span><span class="kt">AppState</span><span class="p">,</span> <span class="kt">Value</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">get</span><span class="p">:</span> <span class="p">{</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Value</span> <span class="k">in</span>
            <span class="k">self</span><span class="o">.</span><span class="n">wrappedValue</span>
        <span class="p">},</span> <span class="nv">set</span><span class="p">:</span> <span class="p">{</span> <span class="n">newValue</span> <span class="k">in</span>
            <span class="k">self</span><span class="o">.</span><span class="n">wrappedValue</span> <span class="o">=</span> <span class="n">newValue</span>
            <span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="nv">keyPath</span><span class="p">:</span> <span class="n">keyPath</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValue</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="o">.</span><span class="nf">sheet</span><span class="p">(</span><span class="nv">isPresented</span><span class="p">:</span> <span class="n">viewState</span><span class="o">.</span><span class="n">showSheet</span><span class="o">.</span><span class="nf">dispatched</span><span class="p">(</span>
                            <span class="nv">to</span><span class="p">:</span> <span class="n">appState</span><span class="p">,</span> <span class="p">\</span><span class="o">.</span><span class="n">routing</span><span class="o">.</span><span class="n">showSheet</span><span class="p">),</span>
               <span class="nv">content</span><span class="p">:</span> <span class="p">{</span> <span class="o">...</span> <span class="p">})</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>There are some ways how this whole solution can be improved syntactically (most notably by using <code class="language-plaintext highlighter-rouge">keyPaths</code>), but conceptually it is a more performant alternative to both <code class="language-plaintext highlighter-rouge">@EnvironmentObject</code> and <code class="language-plaintext highlighter-rouge">@ObservedObject</code>.</p>

<p>For the latter, you’d be injecting <code class="language-plaintext highlighter-rouge">CurrentValueSubject</code> as the <code class="language-plaintext highlighter-rouge">init</code> parameter of the view, in place of the object.</p>

<p>I’ve already migrated my <a href="https://github.com/nalexn/clean-architecture-swiftui">Clean Architecture for SwiftUI</a> sample project to use this approach, and updated my <a href="https://github.com/nalexn/ViewInspector">SwiftUI Unit Testing</a> framework for better supporting it.</p>

      <h2>Your appreciation is my inspiration!</h2>
      <p>I have tons of unpublished kick-ass materials and ideas, but I need your help! Consider sharing this article on <a href="https://twitter.com/share?url=http://nalexn.github.io/swiftui-observableobject/?utm_source=share_tw&amp;text=Why I quit using the ObservableObject&amp;hashtags=iosdev&amp;via=nallexn" title="Twitter" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-twitter share-button"></i></a>, <a href="https://www.facebook.com/sharer/sharer.php?u=http://nalexn.github.io/swiftui-observableobject/?utm_source=share_fb&amp;display=popup&amp;quote=Why I quit using the ObservableObject&amp;hashtag=#iosdev" title="Facebook" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-facebook-f share-button"></i></a> or <a href="https://www.linkedin.com/sharing/share-offsite/?url=http://nalexn.github.io/swiftui-observableobject/?utm_source=share_in" title="LinkedIn" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-linkedin share-button"></i></a>. This tiny action helps to grow this blog and inspires me to post more! (Or if you are nuts, <a href="https://venmo.com/nallexn" target="_blank">Venmo</a> me a drink!)</p>
      </p>
      <p>You can subscribe to <a href="http://nalexn.github.io/feed.xml" target="_blank">RSS feed</a> or follow my <a href="https://twitter.com/nallexn" target="_blank">Twitter</a> for the new articles alerts.

      <div style="width:0px; height:30px; display: block;"></div>
      <h2>Most recent articles</h2>
      <div class="content-box recent clearfix" style="padding: 20px 10px;">
        
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/layers_001.jpg)" href="/separation-of-concerns/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/separation-of-concerns/">Separation of Concerns in Software Design</a></h2>
              <p></p>
              <span class="post-date">2020, Jan 16&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">10 minute read</span>
            </div>
          </article>
          
        
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/comparison_01.jpg)" href="/anyview-vs-group/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/anyview-vs-group/">Performance Battle: AnyView vs Group</a></h2>
              <p></p>
              <span class="post-date">2019, Dec 05&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">12 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/swiftui_unit_testing_01.jpg)" href="/swiftui-unit-testing/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/swiftui-unit-testing/">Who said we cannot unit test SwiftUI views?</a></h2>
              <p></p>
              <span class="post-date">2019, Nov 21&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">18 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/deep_link_swiftui_01.jpg)" href="/swiftui-deep-linking/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/swiftui-deep-linking/">Programmatic navigation in SwiftUI project</a></h2>
              <p></p>
              <span class="post-date">2019, Nov 08&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">11 minute read</span>
            </div>
          </article>
          
        
        <article class="post">
          <a class="post-thumbnail" style="background-image: url(/assets/img/launch_001.jpg)" href="/"></a>
          <div class="post-content">
            <h2 class="post-title"><a href="/">Browse All Articles</a></h2>
            <p></p>
            <span class="post-date">Top iOS programming stuff, no kidding!</span>
          </div>
        </article>
      </div>
    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
</body>
</html>
