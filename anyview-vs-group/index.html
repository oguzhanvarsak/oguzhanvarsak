<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-96224610-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-96224610-1');
  </script>
	<meta charset="utf-8">
	<title>Performance Battle: AnyView vs Group - Alexey Naumov</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Alexey Naumov" property="og:site_name">
  
    <meta content="Performance Battle: AnyView vs Group" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="Verifying the rumors about SwiftUI performance bottlenecks" property="og:description">
  
  
    <meta content="http://nalexn.github.io/anyview-vs-group/" property="og:url">
  
  
    <meta content="2019-12-05T08:30:00+03:00" property="article:published_time">
    <meta content="http://nalexn.github.io/about/" property="article:author">
  
  
    <meta content="http://nalexn.github.io/assets/img/comparison_01.jpg" property="og:image">
  
  
    
  
  
    <meta name="keywords" content="iOS, swift, anyview, performance, issue, bottleneck, ConditionalView, Group, equatable, EquatableView">
    
    <meta content="iOS" property="article:tag">
    
    <meta content="swift" property="article:tag">
    
    <meta content="anyview" property="article:tag">
    
    <meta content="performance" property="article:tag">
    
    <meta content="issue" property="article:tag">
    
    <meta content="bottleneck" property="article:tag">
    
    <meta content="ConditionalView" property="article:tag">
    
    <meta content="Group" property="article:tag">
    
    <meta content="equatable" property="article:tag">
    
    <meta content="EquatableView" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@nallexn">
  
    <meta name="twitter:title" content="Performance Battle: AnyView vs Group">
  
  
    <meta name="twitter:url" content="http://nalexn.github.io/anyview-vs-group/">
  
  
    <meta name="twitter:description" content="Verifying the rumors about SwiftUI performance bottlenecks">
  

	<meta name="description" content="Verifying the rumors about SwiftUI performance bottlenecks">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
  <link rel="icon" sizes="16x16" href="/assets/img/favicon/favicon.ico">
  <link rel="icon" sizes="32x32" href="/assets/img/favicon/favicon-32.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicon/favicon-114.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css?v=2">
</head>

<body>
  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="author-logo">
      <span class="hover-message">Let's connect on LinkedIn!</span>
      <div class="cover-author-image">
        <a href="https://in.linkedin.com/in/nalexn" target="_blank"><img src="/assets/img/profile-image.jpg" alt="Alexey Naumov"></a>
      </div>
      </div>
      <div class="author-name">Alexey Naumov</div>
      <a href="/"><img src="/assets/img/content_00.png" alt="" style="-webkit-border-radius: 0%; border-radius: 0%;"></a>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Links</h3>
      <ul>
        <li><a href="https://twitter.com/nallexn" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        <li><a href="https://in.linkedin.com/in/nalexn" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a href="https://github.com/nalexn" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a href="https://stackoverflow.com/users/2923345?tab=profile" target="_blank"><i class="fa fa-stack-overflow" aria-hidden="true"></i></a></li>
        <li><a href="http://nalexn.github.io/feed.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2020 &copy; Alexey Naumov</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">Performance Battle: AnyView vs Group</h1>
        <div class="page-date"><span>2019, Dec 05&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <div class="page-image"><img class="page-image" src=/assets/img/comparison_01.jpg alt="Performance Battle: AnyView vs Group"></div>
      <p>I’ve recently received a question from an iOS engineer regarding my <a href="https://github.com/nalexn/clean-architecture-swiftui">open source project</a> written with SwiftUI. He shared his concerns regarding the use of <code class="language-plaintext highlighter-rouge">AnyView</code> in the project.</p>

<p>To quickly bring you on the same page, there are <a href="https://twitter.com/mecid/status/1202174460415152128">rumors</a> (<a href="https://www.hackingwithswift.com/quick-start/swiftui/how-to-return-different-view-types">2</a>, <a href="https://twitter.com/twostraws/status/1197626370261688329">3</a>, <a href="https://medium.com/@suyash.srijan/intro-to-swiftui-part-2-6b7e792c21ef">4</a>, <a href="https://swiftwithmajid.com/2019/12/04/must-have-swiftui-extensions/">5</a>, <a href="https://twitter.com/mgorbach/status/1136154973635432448?s=20">6</a>) that <code class="language-plaintext highlighter-rouge">AnyView</code> brings in serious performance implications to the SwiftUI render engine, due to the fact that it erases the type of the underlying view hierarchy thus slowing down the diffing.</p>

<p>The <a href="https://developer.apple.com/documentation/swiftui/anyview">documentation for AnyView</a> says the following:</p>

<blockquote>
  <p>An AnyView allows changing the type of view used in a given view hierarchy. Whenever the type of view used with an AnyView changes, the old hierarchy is destroyed and a new hierarchy is created for the new type.</p>
</blockquote>

<p>This sounds scary. Destroying and rebuilding the entire hierarchy? Oh boy!</p>

<p>But how often does the <strong>type of view</strong> change inside the <code class="language-plaintext highlighter-rouge">AnyView</code>? Probably not too often, unless you’re building an app for developing epilepsy.</p>

<p>If the <strong>type of view</strong> stays the same, but instead a subgraph of the hierarchy contained in <code class="language-plaintext highlighter-rouge">AnyView</code> receives an update, does it behave the same way? Spoiler: it doesn’t.</p>

<p>So what about the performance of diffing the type-erased hierarchy inside <code class="language-plaintext highlighter-rouge">AnyView</code>? Well, there were no benchmarking conducted by anyone from the community.</p>

<p>So in this MythBusters episode, we’ll find out:</p>

<ol>
  <li>How <code class="language-plaintext highlighter-rouge">AnyView</code> performance compares to <code class="language-plaintext highlighter-rouge">ConditionalView</code> (aka <code class="language-plaintext highlighter-rouge">Group { if ... else ... }</code>)</li>
  <li>What are the costs of re-creating the view hierarchy</li>
  <li>What are the real performance bottlenecks in SwiftUI</li>
  <li>How to organize the hierarchy to assure the best performance</li>
</ol>

<p>Let’s get started!</p>

<h2 id="preparing-for-the-test">Preparing for the test</h2>

<p>The most important part of the experiment is to pick the right toolkit and the test samples.</p>

<p>Obviously, we’d need a heavy-weight view carrying many elements to make the diffing harder.</p>

<p>The first variant I came up with was a simple grid of elements like so:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">GridView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>

    <span class="k">let</span> <span class="nv">rows</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">let</span> <span class="nv">columns</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">VStack</span><span class="p">(</span><span class="nv">alignment</span><span class="p">:</span> <span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="nv">spacing</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">ForEach</span><span class="p">(</span><span class="mi">0</span> <span class="o">..&lt;</span> <span class="k">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span> <span class="p">{</span> <span class="n">row</span> <span class="k">in</span>
                <span class="kt">HStack</span><span class="p">(</span><span class="nv">alignment</span><span class="p">:</span> <span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="nv">spacing</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kt">ForEach</span><span class="p">(</span><span class="mi">0</span> <span class="o">..&lt;</span> <span class="k">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="p">{</span> <span class="n">column</span> <span class="k">in</span>
                        <span class="o">&lt;</span><span class="kt">Element</span> <span class="kt">View</span><span class="o">&gt;</span> <span class="c1">// for example, Text("@")</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>But profiler quickly showed that SwiftUI is spending most of the time on… calculating the <strong>layout</strong> of this thing!</p>

<p>So after a few other attempts, I ended up with this template of the test view, that can contain an arbitrary number of elements with minimal layout required:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">StackView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>

    <span class="k">let</span> <span class="nv">count</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">10000</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">ZStack</span> <span class="p">{</span>
            <span class="kt">ForEach</span><span class="p">(</span><span class="mi">0</span> <span class="o">..&lt;</span> <span class="k">self</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span> <span class="n">index</span> <span class="k">in</span>
               <span class="o">&lt;</span><span class="kt">Element</span> <span class="kt">View</span><span class="o">&gt;</span> <span class="c1">// for example, Text("@")</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now, this <code class="language-plaintext highlighter-rouge">StackView</code> could be re-used in various tests, where <code class="language-plaintext highlighter-rouge">&lt;Element View&gt;</code> could be either static view, such as <code class="language-plaintext highlighter-rouge">Text("@")</code>, or a dynamic view that alters the content based on state parameters.</p>

<p>For measuring the performance I’ve used <a href="https://www.hackingwithswift.com/quick-start/swiftui/how-to-use-instruments-to-profile-your-swiftui-code-and-identify-slow-layouts">SwiftUI Profiler from Instruments</a>, which shows lots of useful information, including functions time profiling, the number of times each <code class="language-plaintext highlighter-rouge">body</code> was called, and much more.</p>

<div style="max-width:800px; display: block; margin-left: auto; margin-right: auto;"><img src="http://nalexn.github.io/assets/img/swiftui_profiler_01.png" /></div>

<p>In order to see the performance when launching from Xcode, I’ve used a simple <code class="language-plaintext highlighter-rouge">FPSView</code> that was counting how many render cycles SwiftUI can carry under high load.</p>

<p>All the tests were running on iPhone 7 iOS 13.2.3 for a duration of 1 minute. The phone was lying on a refrigerant bag (was heating up like crazy without it).</p>

<h2 id="test-1-constantly-redrawn-static-content">Test #1: Constantly redrawn static content</h2>

<p>It is obvious that SwiftUI does not constantly recalculate the view hierarchy when there are no changes to the state.</p>

<p>So in all the tests, I had to trigger the hierarchy update by <code class="language-plaintext highlighter-rouge">Timer</code> that was toggling a local <code class="language-plaintext highlighter-rouge">@State var updateTrigger</code>:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">ContentView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">updateTimer</span> <span class="o">=</span> <span class="kt">Timer</span><span class="o">.</span><span class="nf">timer</span><span class="p">(</span><span class="nv">frequency</span><span class="p">:</span> <span class="mi">60</span><span class="p">)</span>
    <span class="kd">@State</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">updateTrigger</span> <span class="o">=</span> <span class="kc">false</span>
    
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="o">&lt;</span><span class="n">testView</span><span class="o">&gt;</span>
        <span class="o">.</span><span class="nf">onReceive</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">updateTimer</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
            <span class="k">self</span><span class="o">.</span><span class="n">updateTrigger</span><span class="o">.</span><span class="nf">toggle</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">&lt;testView&gt;</code>, in this case, was a static view containing 1600 <code class="language-plaintext highlighter-rouge">Text</code> views.</p>

<h3 id="the-test-mechanics">The test mechanics</h3>

<p>SwiftUI hierarchy with <code class="language-plaintext highlighter-rouge">ContentView</code> in the root receives constant refresh requests at a rate of 60 times a second. This triggers the recalculation of the <code class="language-plaintext highlighter-rouge">body</code>, which contains a never-changing statically typed <code class="language-plaintext highlighter-rouge">View</code> with 1600 <code class="language-plaintext highlighter-rouge">Text</code> elements inside.</p>

<p>The test is running for 1 minute under SwiftUI Profiler. For determining the FPS, the FPSView is added to the <code class="language-plaintext highlighter-rouge">ContentView</code>’s body and the app is launched directly from Xcode.</p>

<p>Here are the results for the static content:</p>

<table class="tg">
  <tr>
    <th class="tg-c3ow">Average FPS</th>
    <th class="tg-c3ow">ElementView Body Calls</th>
    <th class="tg-c3ow">Cumulative Body Calculation Time</th>
  </tr>
  <tr>
    <td class="tg-c3ow">60</td>
    <td class="tg-c3ow">1600</td>
    <td class="tg-c3ow">70 ms</td>
  </tr>
</table>

<p>As a bonus, here are the result for the same setup, but when every <code class="language-plaintext highlighter-rouge">Text</code> was wrapped in <code class="language-plaintext highlighter-rouge">AnyView</code></p>

<table class="tg">
  <tr>
    <th class="tg-c3ow">Average FPS</th>
    <th class="tg-c3ow">ElementView Body Calls</th>
    <th class="tg-c3ow">Cumulative Body Calculation Time</th>
  </tr>
  <tr>
    <td class="tg-c3ow">60</td>
    <td class="tg-c3ow">1600</td>
    <td class="tg-c3ow">32 ms</td>
  </tr>
</table>

<p>This is quite surprising, but wrapping element views in <code class="language-plaintext highlighter-rouge">AnyView</code> actually <strong>improved</strong> the performance of <strong>constructing</strong> the body by 50%, but had no visible effect on the diffing performance.</p>

<p>This is not a deal-breaker yet, because construction of the views was taking less than 0,1% of the time (total of 70ms for a 1-minute test).</p>

<p>In addition to the data from the profiler, I run a simple benchmarking in the code and found that creation of the test view with or without <code class="language-plaintext highlighter-rouge">AnyView</code> is taking between <strong>3-4 nanoseconds</strong>:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">startTime</span> <span class="o">=</span> <span class="kt">Date</span><span class="p">()</span><span class="o">.</span><span class="n">timeIntervalSinceReferenceDate</span>
<span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="mi">0</span> <span class="o">...</span> <span class="mi">1_000_000</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">view</span> <span class="o">=</span> <span class="kt">StackView</span><span class="p">(</span><span class="nv">count</span><span class="p">:</span> <span class="mi">1600</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">body</span>
<span class="p">}</span>
<span class="k">let</span> <span class="nv">endTime</span> <span class="o">=</span> <span class="kt">Date</span><span class="p">()</span><span class="o">.</span><span class="n">timeIntervalSinceReferenceDate</span>
<span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="se">)</span><span class="s">"</span><span class="p">)</span> <span class="c1">// prints out "3.5399050..."</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This means that the creation of the hierarchy is <strong>incredibly fast</strong>, SwiftUI is able to produce ~285k <code class="language-plaintext highlighter-rouge">View</code> structs a second! And don’t think that <code class="language-plaintext highlighter-rouge">Text</code> is a lightweight struct: reflection shows it has a quite complex inner structure for handling the string localization and formatting, and font modifiers, etc.</p>

<ul>
  <li><a href="https://github.com/nalexn/blob_files/raw/master/files/swiftui_profiling/StaticContent.trace.zip">Profiling file</a> for <code class="language-plaintext highlighter-rouge">Text</code></li>
  <li><a href="https://github.com/nalexn/blob_files/raw/master/files/swiftui_profiling/StaticContentAnyView.trace.zip">Profiling file</a> for <code class="language-plaintext highlighter-rouge">AnyView(Text)</code></li>
</ul>

<h2 id="test-2-tweaking-one-element-inside-a-massive-view">Test #2: Tweaking one element inside a massive view</h2>

<p>The purpose of this test was to see how SwiftUI can perform diffing of the hierarchy when 99.9% of content remains unchanged.</p>

<p>The <code class="language-plaintext highlighter-rouge">&lt;elementView&gt;</code> is a dynamic view capable of toggling the content between static <code class="language-plaintext highlighter-rouge">Text</code> and static <code class="language-plaintext highlighter-rouge">Image</code>. Underlying <code class="language-plaintext highlighter-rouge">UIImage</code> has a small size (6x10 pixels) and is cached in a static variable to assure the best performance.</p>

<p>Three variations of <code class="language-plaintext highlighter-rouge">&lt;elementView&gt;</code> were tested:</p>

<h4 id="1-conditionalview">1. ConditionalView</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kt">Group</span> <span class="p">{</span>
        <span class="k">if</span> <span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="kt">Image</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kt">Text</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="2-anyview">2. AnyView</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="k">if</span> <span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">AnyView</span><span class="p">(</span><span class="kt">Image</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">AnyView</span><span class="p">(</span><span class="kt">Text</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="3-equatableview">3. EquatableView</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">ElementView</span><span class="p">:</span> <span class="kt">Equatable</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">same</span> <span class="k">as</span> <span class="k">for</span> <span class="kt">ConditionalView</span><span class="o">&gt;</span> <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="o">==</span> <span class="p">(</span><span class="nv">lhs</span><span class="p">:</span> <span class="k">Self</span><span class="p">,</span> <span class="nv">rhs</span><span class="p">:</span> <span class="k">Self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">view</span> <span class="o">=</span> <span class="kt">ElementView</span><span class="p">()</span><span class="o">.</span><span class="nf">equatable</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="the-test-mechanics-1">The test mechanics</h3>

<p>SwiftUI hierarchy receives constant refresh requests at a rate of 60 times a second. The hierarchy contains 1600 <code class="language-plaintext highlighter-rouge">ElementViews</code> able to toggle between <code class="language-plaintext highlighter-rouge">Text</code> and <code class="language-plaintext highlighter-rouge">Image</code> based on a <code class="language-plaintext highlighter-rouge">Binding</code> parameter they receive upon initialization.</p>

<p>The test is constructed in a way that only one <code class="language-plaintext highlighter-rouge">ElementView</code> has to constantly toggle between <code class="language-plaintext highlighter-rouge">Text</code> and <code class="language-plaintext highlighter-rouge">Image</code>, while others stay <code class="language-plaintext highlighter-rouge">Text</code> all the time. Since all <code class="language-plaintext highlighter-rouge">ElementViews</code> are hooked on the update from <code class="language-plaintext highlighter-rouge">Binding</code>, it’s the job of the SwiftUI engine to properly run diffing of all 1600 views for optimal rendering.</p>

<p>The average time for calling <code class="language-plaintext highlighter-rouge">.init()</code> + <code class="language-plaintext highlighter-rouge">.body</code> for the test view is again ~4 nanoseconds.</p>

<p>The results for <code class="language-plaintext highlighter-rouge">ConditionalView </code>:</p>

<table class="tg">
  <tr>
    <th class="tg-c3ow">Average FPS</th>
    <th class="tg-c3ow">ElementView Body Calls</th>
    <th class="tg-c3ow">Cumulative Body Calculation Time</th>
  </tr>
  <tr>
    <td class="tg-c3ow">10</td>
    <td class="tg-c3ow">355,000</td>
    <td class="tg-c3ow">2180 ms</td>
  </tr>
</table>

<p>The results for <code class="language-plaintext highlighter-rouge">AnyView </code>:</p>

<table class="tg">
  <tr>
    <th class="tg-c3ow">Average FPS</th>
    <th class="tg-c3ow">ElementView Body Calls</th>
    <th class="tg-c3ow">Cumulative Body Calculation Time</th>
  </tr>
  <tr>
    <td class="tg-c3ow">10</td>
    <td class="tg-c3ow">355,000</td>
    <td class="tg-c3ow">2130 ms</td>
  </tr>
</table>

<p>The results for <code class="language-plaintext highlighter-rouge">EquatableView</code>:</p>

<table class="tg">
  <tr>
    <th class="tg-c3ow">Average FPS</th>
    <th class="tg-c3ow">ElementView Body Calls</th>
    <th class="tg-c3ow">Cumulative Body Calculation Time</th>
  </tr>
  <tr>
    <td class="tg-c3ow">18</td>
    <td class="tg-c3ow">440,000</td>
    <td class="tg-c3ow">2640 ms</td>
  </tr>
</table>

<p>Pretty interesting results. Here are the observations we need to note:</p>

<ol>
  <li>The performance of diffing the content for <code class="language-plaintext highlighter-rouge">ConditionalView</code> and <code class="language-plaintext highlighter-rouge">AnyView</code> is practically the same, based on the FPS.</li>
  <li><code class="language-plaintext highlighter-rouge">EquatableView</code> almost <strong>doubled the FPS</strong> compared to the other two. Because of this SwiftUI was able to run more render cycles in the allocated minute, resulting in a higher number of body calls and calculation time.</li>
  <li>From the syntax of <code class="language-plaintext highlighter-rouge">ConditionalView</code> there may be an illusion that views for “true” and “false” branches are both cached. This is not true - the reflection shows that only one view gets cached at a time. The results of the experiment correspond with this fact: the cumulative body calculation time for <code class="language-plaintext highlighter-rouge">AnyView</code> and <code class="language-plaintext highlighter-rouge">ConditionalView</code> is about the same. <strong>Both <code class="language-plaintext highlighter-rouge">AnyView</code> and <code class="language-plaintext highlighter-rouge">ConditionalView</code> are re-creating the inner hierarchy when the type of view changes.</strong></li>
  <li>In order to <strong>compare</strong> two hierarchies of views, the other one has to be <strong>created</strong>. Yes, we thought the worst thing that may happen is the re-creation of the hierarchy, but SwiftUI is doing this <strong>all the time</strong> for calculation of the diff. We can help it by making the view <code class="language-plaintext highlighter-rouge">Equatable</code> and wrapping it inside <code class="language-plaintext highlighter-rouge">EquatableView</code>. This way SwiftUI does not have to call the computed variable <code class="language-plaintext highlighter-rouge">body</code> for identifying if the content has changed or not.</li>
</ol>

<ul>
  <li><a href="https://github.com/nalexn/blob_files/raw/master/files/swiftui_profiling/RegularViewUpdate.trace.zip">Profiling file</a> for <code class="language-plaintext highlighter-rouge">ConditionalView</code></li>
  <li><a href="https://github.com/nalexn/blob_files/raw/master/files/swiftui_profiling/TypeErasedViewUpdate.trace.zip">Profiling file</a> for <code class="language-plaintext highlighter-rouge">AnyView</code></li>
  <li><a href="https://github.com/nalexn/blob_files/raw/master/files/swiftui_profiling/EquatableViewUpdate.trace.zip">Profiling file</a> for <code class="language-plaintext highlighter-rouge">EquatableView</code></li>
</ul>

<h2 id="test-3-toggle-between-two-static-massive-views">Test #3: Toggle between two static massive views</h2>

<p>This is the last challenge in the battle of <code class="language-plaintext highlighter-rouge">AnyView</code> and <code class="language-plaintext highlighter-rouge">ConditionalView</code>.</p>

<p>We have two static massive views of different inner structures and types.</p>

<p>The job of the <code class="language-plaintext highlighter-rouge">AnyView</code> and <code class="language-plaintext highlighter-rouge">ConditionalView</code> is to toggle between these two views at the highest possible rate.</p>

<p>This way we can find out if content switching inside <code class="language-plaintext highlighter-rouge">ConditionalView</code> is more performant than “destroying and re-building the view hierarchy” by <code class="language-plaintext highlighter-rouge">AnyView</code>.</p>

<h3 id="the-test-mechanics-2">The test mechanics</h3>

<p>In the setup, we have two never-changing massive views, both containing 225 elements of types <code class="language-plaintext highlighter-rouge">Text</code> and <code class="language-plaintext highlighter-rouge">Image</code> respectively.</p>

<p>The code for testing <code class="language-plaintext highlighter-rouge">ConditionalView</code> and <code class="language-plaintext highlighter-rouge">AnyView</code>:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">testConditionalView</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kt">Group</span> <span class="p">{</span>
        <span class="k">if</span> <span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span> <span class="p">{</span>
            <span class="kt">TextStackView</span><span class="p">(</span><span class="nv">count</span><span class="p">:</span> <span class="mi">225</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kt">ImageStackView</span><span class="p">(</span><span class="nv">count</span><span class="p">:</span> <span class="mi">225</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">var</span> <span class="nv">testAnyView</span><span class="p">:</span> <span class="n">some</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="k">if</span> <span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">AnyView</span><span class="p">(</span><span class="kt">TextStackView</span><span class="p">(</span><span class="nv">count</span><span class="p">:</span> <span class="mi">225</span><span class="p">))</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">AnyView</span><span class="p">(</span><span class="kt">ImageStackView</span><span class="p">(</span><span class="nv">count</span><span class="p">:</span> <span class="mi">225</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">&lt;condition&gt;</code> is toggled by <code class="language-plaintext highlighter-rouge">Timer</code> a rate of 60 times a second.</p>

<p>The results for <code class="language-plaintext highlighter-rouge">ConditionalView</code></p>

<table class="tg">
  <tr>
    <th class="tg-c3ow">Average FPS</th>
    <th class="tg-c3ow">ElementView Body Calls</th>
    <th class="tg-c3ow">Cumulative Body Calculation Time</th>
  </tr>
  <tr>
    <td class="tg-c3ow">18</td>
    <td class="tg-c3ow">244,000</td>
    <td class="tg-c3ow">1450 ms</td>
  </tr>
</table>

<p>The results for <code class="language-plaintext highlighter-rouge">AnyView</code></p>

<table class="tg">
  <tr>
    <th class="tg-c3ow">Average FPS</th>
    <th class="tg-c3ow">ElementView Body Calls</th>
    <th class="tg-c3ow">Cumulative Body Calculation Time</th>
  </tr>
  <tr>
    <td class="tg-c3ow">20</td>
    <td class="tg-c3ow">255,000</td>
    <td class="tg-c3ow">1430 ms</td>
  </tr>
</table>

<p>Who placed the bet on <code class="language-plaintext highlighter-rouge">ConditionalView</code>? I guess, most of us did…</p>

<p>But it turns out that <code class="language-plaintext highlighter-rouge">ConditionalView</code> not only cannot beat <code class="language-plaintext highlighter-rouge">AnyView</code>, it is even a bit slower: in these two tests, SwiftUI was able to perform by 5% more render cycles for <code class="language-plaintext highlighter-rouge">AnyView</code> than for <code class="language-plaintext highlighter-rouge">Group</code>!</p>

<p>You can compare the profiling files:</p>

<ul>
  <li><a href="https://github.com/nalexn/blob_files/raw/master/files/swiftui_profiling/ToggleContentConditional.trace.zip">Profiling file</a> for <code class="language-plaintext highlighter-rouge">ConditionalView</code></li>
  <li><a href="https://github.com/nalexn/blob_files/raw/master/files/swiftui_profiling/ToggleContentAnyView.trace.zip">Profiling file</a> for <code class="language-plaintext highlighter-rouge">AnyView</code></li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>I cannot say there is a clear leader among <code class="language-plaintext highlighter-rouge">AnyView</code> and <code class="language-plaintext highlighter-rouge">ConditionalView</code>, but the myth about negative <code class="language-plaintext highlighter-rouge">AnyView</code> performance implication is <em>BUSTED</em>.</p>

<p>This was tested on micro views, as well as on massive views: <code class="language-plaintext highlighter-rouge">AnyView</code> does not slow down the diffing for tiny updates, but actually performs better with major content changes.</p>

<p>Based on the condition in the <code class="language-plaintext highlighter-rouge">if</code>, the <code class="language-plaintext highlighter-rouge">ConditionalView</code> does cache only <em>one</em> contained view. So practically it <em>destroys and recreates</em> the content just like <code class="language-plaintext highlighter-rouge">AnyView</code> does.</p>

<p>There is no reason to fear the words <em>“old hierarchy is destroyed and a new hierarchy is created”</em>. The re-creation of the SwiftUI view hierarchy is practically free. In fact, the SwiftUI engine does create a new sub-hierarchy every time for <em>comparing</em> the content. You cannot compare A to B without creating B, right?</p>

<p>The real performance bottleneck turns out to be the inner layout system of SwiftUI. I’m sure this will be optimized later, but for now, we just need to make sure to bind the state as low as possible in the hierarchy, so that SwiftUI had to recalculate only the small subgraphs of the hierarchy.</p>

<p>When you access a <code class="language-plaintext highlighter-rouge">Binding</code>, <code class="language-plaintext highlighter-rouge">@State</code>, <code class="language-plaintext highlighter-rouge">@ObservedObject</code> or <code class="language-plaintext highlighter-rouge">@EnvironmentObject</code> from the view’s <code class="language-plaintext highlighter-rouge">body</code>, SwiftUI associates this view with <strong>any</strong> updates of that state. Even if the body returns the same result as before - SwiftUI recalculates the layout regardless.</p>

<p>One of the ways to improve the performance is to use <code class="language-plaintext highlighter-rouge">EquatableView</code>, which allows SwiftUI to take a shortcut and not call the <code class="language-plaintext highlighter-rouge">body</code> if your view says it did not change.</p>

<p>And finally: <strong>Premature optimization is the root of all evil</strong>. Use SwiftUI Profiler in the Instruments for locating the real performance bottleneck instead of guessing, and don’t trade the code clarity for a couple of nanoseconds of performance advantage.</p>

<p>The source code for the project can be found on <a href="https://github.com/nalexn/anyview-vs-group">GitHub</a>.</p>

      <h2>Your appreciation is my inspiration!</h2>
      <p>I have tons of unpublished kick-ass materials and ideas, but I need your help! Consider sharing this article on <a href="https://twitter.com/share?url=http://nalexn.github.io/anyview-vs-group/?utm_source=share_tw&amp;text=Performance Battle: AnyView vs Group&amp;hashtags=iosdev&amp;via=nallexn" title="Twitter" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-twitter share-button"></i></a>, <a href="https://www.facebook.com/sharer/sharer.php?u=http://nalexn.github.io/anyview-vs-group/?utm_source=share_fb&amp;display=popup&amp;quote=Performance Battle: AnyView vs Group&amp;hashtag=#iosdev" title="Facebook" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-facebook-f share-button"></i></a> or <a href="https://www.linkedin.com/sharing/share-offsite/?url=http://nalexn.github.io/anyview-vs-group/?utm_source=share_in" title="LinkedIn" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-linkedin share-button"></i></a>. This tiny action helps to grow this blog and inspires me to post more! (Or if you are nuts, <a href="https://venmo.com/nallexn" target="_blank">Venmo</a> me a drink!)</p>
      </p>
      <p>You can subscribe to <a href="http://nalexn.github.io/feed.xml" target="_blank">RSS feed</a> or follow my <a href="https://twitter.com/nallexn" target="_blank">Twitter</a> for the new articles alerts.

      <div style="width:0px; height:30px; display: block;"></div>
      <h2>Most recent articles</h2>
      <div class="content-box recent clearfix" style="padding: 20px 10px;">
        
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/layers_001.jpg)" href="/separation-of-concerns/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/separation-of-concerns/">Separation of Concerns in Software Design</a></h2>
              <p></p>
              <span class="post-date">2020, Jan 16&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">10 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/observable_001.jpg)" href="/swiftui-observableobject/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/swiftui-observableobject/">Why I quit using the ObservableObject</a></h2>
              <p></p>
              <span class="post-date">2019, Dec 20&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">7 minute read</span>
            </div>
          </article>
          
        
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/swiftui_unit_testing_01.jpg)" href="/swiftui-unit-testing/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/swiftui-unit-testing/">Who said we cannot unit test SwiftUI views?</a></h2>
              <p></p>
              <span class="post-date">2019, Nov 21&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">18 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/deep_link_swiftui_01.jpg)" href="/swiftui-deep-linking/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/swiftui-deep-linking/">Programmatic navigation in SwiftUI project</a></h2>
              <p></p>
              <span class="post-date">2019, Nov 08&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">11 minute read</span>
            </div>
          </article>
          
        
        <article class="post">
          <a class="post-thumbnail" style="background-image: url(/assets/img/launch_001.jpg)" href="/"></a>
          <div class="post-content">
            <h2 class="post-title"><a href="/">Browse All Articles</a></h2>
            <p></p>
            <span class="post-date">Top iOS programming stuff, no kidding!</span>
          </div>
        </article>
      </div>
    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
</body>
</html>
