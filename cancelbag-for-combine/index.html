<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-96224610-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-96224610-1');
  </script>
	<meta charset="utf-8">
	<title>Variadic DisposeBag for Combine subscriptions - Alexey Naumov</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Alexey Naumov" property="og:site_name">
  
    <meta content="Variadic DisposeBag for Combine subscriptions" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="Collecting AnyCancellable tokens in declarative SwiftUI fashion" property="og:description">
  
  
    <meta content="http://nalexn.github.io/cancelbag-for-combine/" property="og:url">
  
  
    <meta content="2019-10-04T14:30:00+03:00" property="article:published_time">
    <meta content="http://nalexn.github.io/about/" property="article:author">
  
  
    <meta content="http://nalexn.github.io/assets/img/bag_001.jpg" property="og:image">
  
  
    
  
  
    <meta name="keywords" content="Cancellable, AnyCancellable, iOS, swift, SwiftUI, RxSwift, functionBuilder">
    
    <meta content="Cancellable" property="article:tag">
    
    <meta content="AnyCancellable" property="article:tag">
    
    <meta content="iOS" property="article:tag">
    
    <meta content="swift" property="article:tag">
    
    <meta content="SwiftUI" property="article:tag">
    
    <meta content="RxSwift" property="article:tag">
    
    <meta content="functionBuilder" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@nallexn">
  
    <meta name="twitter:title" content="Variadic DisposeBag for Combine subscriptions">
  
  
    <meta name="twitter:url" content="http://nalexn.github.io/cancelbag-for-combine/">
  
  
    <meta name="twitter:description" content="Collecting AnyCancellable tokens in declarative SwiftUI fashion">
  

	<meta name="description" content="Collecting AnyCancellable tokens in declarative SwiftUI fashion">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
  <link rel="icon" sizes="16x16" href="/assets/img/favicon/favicon.ico">
  <link rel="icon" sizes="32x32" href="/assets/img/favicon/favicon-32.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicon/favicon-114.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css?v=2">
</head>

<body>
  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="author-logo">
      <span class="hover-message">Let's connect on LinkedIn!</span>
      <div class="cover-author-image">
        <a href="https://in.linkedin.com/in/nalexn" target="_blank"><img src="/assets/img/profile-image.jpg" alt="Alexey Naumov"></a>
      </div>
      </div>
      <div class="author-name">Alexey Naumov</div>
      <a href="/"><img src="/assets/img/content_00.png" alt="" style="-webkit-border-radius: 0%; border-radius: 0%;"></a>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Links</h3>
      <ul>
        <li><a href="https://twitter.com/nallexn" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        <li><a href="https://in.linkedin.com/in/nalexn" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a href="https://github.com/nalexn" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a href="https://stackoverflow.com/users/2923345?tab=profile" target="_blank"><i class="fa fa-stack-overflow" aria-hidden="true"></i></a></li>
        <li><a href="http://nalexn.github.io/feed.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2020 &copy; Alexey Naumov</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">Variadic DisposeBag for Combine subscriptions</h1>
        <div class="page-date"><span>2019, Oct 04&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <div class="page-image"><img class="page-image" src=/assets/img/bag_001.jpg alt="Variadic DisposeBag for Combine subscriptions"></div>
      <p>With the announce of <a href="https://developer.apple.com/documentation/swiftui/">SwiftUI</a> and <a href="https://developer.apple.com/documentation/combine">Combine</a> frameworks on WWDC2019 Apple has clearly outlined their vision on the future of the software development for their platforms, and that future is going to be <em>Reactive</em>.</p>

<p>Just like it happened in the past with ARC for Objective-C, Autolayout, or Swift, there is only a couple years lag between the announce of the new Apple’s technology, and it’s pervasive use. So if one was still reluctant about learning functional reactive programming, now they are left with a choice to board the Rocket now or stay in the fading world of object-oriented UIKit.</p>

<p>However, Apple has made a great job of making the transition as seamless as possible for developers: Combine is a masterpiece of simplicity, among other reactive frameworks.</p>

<p>It provides really concise and programmer-friendly API that’s just enough for basic handling of the “values over time”.</p>

<h2 id="houston-we-have-aproblem">Houston, we have a problem…</h2>

<p>As you’d expect from the conciseness of the API, there always will be someone who’s missing his <a href="https://rxmarbles.com/">favorite fancy operator</a> from a reactive framework they’re used to.</p>

<p>I understand that. But it feels like Combine is missing something fundamental, and the suggested alternative seems cumbersome and old-fashioned: I’m talking about the <strong>memory management of the subscriptions</strong>.</p>

<p><a href="https://github.com/ReactiveX/RxSwift">RxSwift</a> provides us with <a href="https://github.com/ReactiveX/RxSwift/blob/master/RxSwift/Disposables/DisposeBag.swift">DisposeBag</a>; it’s competitor, <a href="https://github.com/ReactiveCocoa/ReactiveSwift">ReactiveSwift</a>, has a counterpart: <a href="https://github.com/ReactiveCocoa/ReactiveSwift/blob/master/Sources/Lifetime.swift">Lifetime</a>.</p>

<p>But what about Combine? The subscription returns a token of type <a href="https://developer.apple.com/documentation/combine/anycancellable">AnyCancellable</a> that prior Xcode 11.1 we couldn’t put anywhere except for storing in an instance variable:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">ValueConsumer</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">subscription1</span><span class="p">:</span> <span class="kt">AnyCancellable</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">subscription2</span><span class="p">:</span> <span class="kt">AnyCancellable</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">subscription3</span><span class="p">:</span> <span class="kt">AnyCancellable</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">mySubject</span> <span class="o">=</span> <span class="kt">CurrentValueSubject</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">myVar</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="kd">func</span> <span class="nf">consumeValues</span><span class="p">(</span><span class="n">publisher1</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">subscription1</span> <span class="o">=</span> <span class="n">publisher1</span>
            <span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="nf">print</span><span class="p">(</span><span class="s">"New value: </span><span class="se">\(</span><span class="nv">$0</span><span class="se">)</span><span class="s">"</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">subscription2</span> <span class="o">=</span> <span class="n">mySubject</span>
            <span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="n">publisher2</span><span class="p">)</span>
        <span class="n">subscription3</span> <span class="o">=</span> <span class="n">publisher3</span>
            <span class="o">.</span><span class="nf">assign</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="p">\</span><span class="o">.</span><span class="n">myVar</span><span class="p">,</span> <span class="nv">on</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Xcode 11.1 added method <code class="language-plaintext highlighter-rouge">store(in: Set&lt;AnyCancellable&gt;)</code> in an extension for <code class="language-plaintext highlighter-rouge">AnyCancellable</code>, so the code now can be refactored this way:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">ValueConsumer</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">cancelBag</span> <span class="o">=</span> <span class="kt">Set</span><span class="o">&lt;</span><span class="kt">AnyCancellable</span><span class="o">&gt;</span><span class="p">()</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">mySubject</span> <span class="o">=</span> <span class="kt">CurrentValueSubject</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">myVar</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="kd">func</span> <span class="nf">consumeValues</span><span class="p">(</span><span class="n">publisher1</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">publisher1</span>
            <span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="nf">print</span><span class="p">(</span><span class="s">"New value: </span><span class="se">\(</span><span class="nv">$0</span><span class="se">)</span><span class="s">"</span><span class="p">)</span> <span class="p">}</span>
            <span class="o">.</span><span class="nf">store</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">cancelBag</span><span class="p">)</span>
        <span class="n">subscription2</span> <span class="o">=</span> <span class="n">mySubject</span>
            <span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="n">publisher2</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">store</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">cancelBag</span><span class="p">)</span>
        <span class="n">subscription3</span> <span class="o">=</span> <span class="n">publisher3</span>
            <span class="o">.</span><span class="nf">assign</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="p">\</span><span class="o">.</span><span class="n">myVar</span><span class="p">,</span> <span class="nv">on</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">store</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">cancelBag</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Even though this looks cleaner, the number of lines stayed about the same.</p>

<p>But how about taking one step further and implement <a href="https://medium.com/@michaellong/rxswifty-and-his-variadic-disposebag-1682ecceaf41">Variadic DisposeBag</a>?</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">ValueConsumer</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">cancelBag</span> <span class="o">=</span> <span class="kt">Set</span><span class="o">&lt;</span><span class="kt">AnyCancellable</span><span class="o">&gt;</span><span class="p">()</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">mySubject</span> <span class="o">=</span> <span class="kt">CurrentValueSubject</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">myVar</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="kd">func</span> <span class="nf">consumeValues</span><span class="p">(</span><span class="n">publisher1</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cancelBag</span><span class="o">.</span><span class="n">collect</span> <span class="p">{</span>
            <span class="n">publisher1</span>
                <span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="nf">print</span><span class="p">(</span><span class="s">"New value: </span><span class="se">\(</span><span class="nv">$0</span><span class="se">)</span><span class="s">"</span><span class="p">)</span> <span class="p">}</span>
            <span class="n">mySubject</span>
                <span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="n">publisher2</span><span class="p">)</span>
            <span class="n">publisher3</span>
                <span class="o">.</span><span class="nf">assign</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="p">\</span><span class="o">.</span><span class="n">myVar</span><span class="p">,</span> <span class="nv">on</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">collect</code> function above is using the new <a href="https://blog.vihan.org/swift-function-builders/"><code class="language-plaintext highlighter-rouge">@functionBuilder</code></a> attribute available in Swift 5.1, the same one that allows view containers from <a href="https://developer.apple.com/documentation/swiftui/">SwiftUI</a>, such as <code class="language-plaintext highlighter-rouge">VStack</code>, to take an array of elements without any <code class="language-plaintext highlighter-rouge">,</code> separators.</p>

<p>So now we can collect all the subscriptions tokens without explicitly calling <code class="language-plaintext highlighter-rouge">.store(in: &amp;cancelBag)</code></p>

<p>The full gist for the CancelBag implementation (~20 lines of code) can be <a href="https://gist.github.com/nalexn/33f14af1d163ea476ee499c0459824b2">found on Github</a>.</p>

      <h2>Your appreciation is my inspiration!</h2>
      <p>I have tons of unpublished kick-ass materials and ideas, but I need your help! Consider sharing this article on <a href="https://twitter.com/share?url=http://nalexn.github.io/cancelbag-for-combine/?utm_source=share_tw&amp;text=Variadic DisposeBag for Combine subscriptions&amp;hashtags=iosdev&amp;via=nallexn" title="Twitter" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-twitter share-button"></i></a>, <a href="https://www.facebook.com/sharer/sharer.php?u=http://nalexn.github.io/cancelbag-for-combine/?utm_source=share_fb&amp;display=popup&amp;quote=Variadic DisposeBag for Combine subscriptions&amp;hashtag=#iosdev" title="Facebook" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-facebook-f share-button"></i></a> or <a href="https://www.linkedin.com/sharing/share-offsite/?url=http://nalexn.github.io/cancelbag-for-combine/?utm_source=share_in" title="LinkedIn" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-linkedin share-button"></i></a>. This tiny action helps to grow this blog and inspires me to post more! (Or if you are nuts, <a href="https://venmo.com/nallexn" target="_blank">Venmo</a> me a drink!)</p>
      </p>
      <p>You can subscribe to <a href="http://nalexn.github.io/feed.xml" target="_blank">RSS feed</a> or follow my <a href="https://twitter.com/nallexn" target="_blank">Twitter</a> for the new articles alerts.

      <div style="width:0px; height:30px; display: block;"></div>
      <h2>Most recent articles</h2>
      <div class="content-box recent clearfix" style="padding: 20px 10px;">
        
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/layers_001.jpg)" href="/separation-of-concerns/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/separation-of-concerns/">Separation of Concerns in Software Design</a></h2>
              <p></p>
              <span class="post-date">2020, Jan 16&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">10 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/observable_001.jpg)" href="/swiftui-observableobject/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/swiftui-observableobject/">Why I quit using the ObservableObject</a></h2>
              <p></p>
              <span class="post-date">2019, Dec 20&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">7 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/comparison_01.jpg)" href="/anyview-vs-group/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/anyview-vs-group/">Performance Battle: AnyView vs Group</a></h2>
              <p></p>
              <span class="post-date">2019, Dec 05&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">9 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/swiftui_unit_testing_01.jpg)" href="/swiftui-unit-testing/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/swiftui-unit-testing/">Who said we cannot unit test SwiftUI views?</a></h2>
              <p></p>
              <span class="post-date">2019, Nov 21&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">12 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/deep_link_swiftui_01.jpg)" href="/swiftui-deep-linking/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/swiftui-deep-linking/">Programmatic navigation in SwiftUI project</a></h2>
              <p></p>
              <span class="post-date">2019, Nov 08&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">7 minute read</span>
            </div>
          </article>
          
        
        <article class="post">
          <a class="post-thumbnail" style="background-image: url(/assets/img/launch_001.jpg)" href="/"></a>
          <div class="post-content">
            <h2 class="post-title"><a href="/">Browse All Articles</a></h2>
            <p></p>
            <span class="post-date">Top iOS programming stuff, no kidding!</span>
          </div>
        </article>
      </div>
    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
</body>
</html>
