<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-96224610-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-96224610-1');
  </script>
	<meta charset="utf-8">
	<title>Fighting state redundancy in Model-View-ViewModel - Alexey Naumov</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Alexey Naumov" property="og:site_name">
  
    <meta content="Fighting state redundancy in Model-View-ViewModel" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="A better way to represent the state of loading resource in MVVM" property="og:description">
  
  
    <meta content="http://nalexn.github.io/mvvm-state-redundancy/" property="og:url">
  
  
    <meta content="2019-09-29T14:30:00+03:00" property="article:published_time">
    <meta content="http://nalexn.github.io/about/" property="article:author">
  
  
    <meta content="http://nalexn.github.io/assets/img/state_002.jpg" property="og:image">
  
  
    
  
  
    <meta name="keywords" content="mvvm, model, view, viewmodel, view-model, state, frp, rxswift, functional, reactive, ios, swift">
    
    <meta content="mvvm" property="article:tag">
    
    <meta content="model" property="article:tag">
    
    <meta content="view" property="article:tag">
    
    <meta content="viewmodel" property="article:tag">
    
    <meta content="view-model" property="article:tag">
    
    <meta content="state" property="article:tag">
    
    <meta content="frp" property="article:tag">
    
    <meta content="rxswift" property="article:tag">
    
    <meta content="functional" property="article:tag">
    
    <meta content="reactive" property="article:tag">
    
    <meta content="ios" property="article:tag">
    
    <meta content="swift" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@nallexn">
  
    <meta name="twitter:title" content="Fighting state redundancy in Model-View-ViewModel">
  
  
    <meta name="twitter:url" content="http://nalexn.github.io/mvvm-state-redundancy/">
  
  
    <meta name="twitter:description" content="A better way to represent the state of loading resource in MVVM">
  

	<meta name="description" content="A better way to represent the state of loading resource in MVVM">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
  <link rel="icon" sizes="16x16" href="/assets/img/favicon/favicon.ico">
  <link rel="icon" sizes="32x32" href="/assets/img/favicon/favicon-32.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicon/favicon-114.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css?v=2">
</head>

<body>
  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="author-logo">
      <span class="hover-message">Let's connect on LinkedIn!</span>
      <div class="cover-author-image">
        <a href="https://in.linkedin.com/in/nalexn" target="_blank"><img src="/assets/img/profile-image.jpg" alt="Alexey Naumov"></a>
      </div>
      </div>
      <div class="author-name">Alexey Naumov</div>
      <a href="/"><img src="/assets/img/content_00.png" alt="" style="-webkit-border-radius: 0%; border-radius: 0%;"></a>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Links</h3>
      <ul>
        <li><a href="https://twitter.com/nallexn" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        <li><a href="https://in.linkedin.com/in/nalexn" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a href="https://github.com/nalexn" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a href="https://stackoverflow.com/users/2923345?tab=profile" target="_blank"><i class="fa fa-stack-overflow" aria-hidden="true"></i></a></li>
        <li><a href="http://nalexn.github.io/feed.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2020 &copy; Alexey Naumov</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">Fighting state redundancy in Model-View-ViewModel</h1>
        <div class="page-date"><span>2019, Sep 29&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <div class="page-image"><img class="page-image" src=/assets/img/state_002.jpg alt="Fighting state redundancy in Model-View-ViewModel"></div>
      <p>One of the most common practical problems in mobile apps is loading displayable data from the server, where the data can be anything from user’s feed or a list of podcasts to a profile picture or a streaming video.</p>

<p>Apps show various spinners and bars to indicate the loading process, all for inducing user’s patience and improving their experience.</p>

<p>However, this seemingly trivial problem has hidden pitfalls for a programmer, where a naive implementation can lead to writing excessive code and fixing sudden bugs.</p>

<p>Let’s take a simple example where we need to load and display a list of podcasts using <a href="https://en.wikipedia.org/wiki/Model-view-viewmodel">Model-View-ViewModel</a> pattern for the screen structure with <a href="https://github.com/ReactiveX/RxSwift">RxSwift</a> for UI binding.</p>

<h3 id="model">Model</h3>

<p>An immutable struct for holding basic info about a podcast record:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">Podcast</span><span class="p">:</span> <span class="kt">Equatable</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">title</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">previewImage</span><span class="p">:</span> <span class="kt">UIImage</span>
    <span class="k">let</span> <span class="nv">podcastURL</span><span class="p">:</span> <span class="kt">URL</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The networking layer is represented with this tiny protocol; I’ll omit the factual networking code for simplicity of the example:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">PodcastsService</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">loadPodcasts</span><span class="p">(</span><span class="nv">completion</span><span class="p">:</span> <span class="p">(</span><span class="kt">Result</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Podcast</span><span class="p">],</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="viewmodel">ViewModel</h3>

<p>For the list of podcasts, we’ll need to have an observable array of <code class="language-plaintext highlighter-rouge">Podcast</code> structures. For that, we wrap <code class="language-plaintext highlighter-rouge">[Podcast]</code> in the <code class="language-plaintext highlighter-rouge">BehaviorRelay</code> class from <code class="language-plaintext highlighter-rouge">RxSwift</code>, which is basically an <strong>observable property</strong> that always holds a value:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">PodcastsViewModel</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">PodcastsService</span>
    
    <span class="k">let</span> <span class="nv">podcasts</span> <span class="o">=</span> <span class="kt">BehaviorRelay</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Podcast</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="p">[])</span>
    
    <span class="kd">func</span> <span class="nf">loadPodcasts</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">service</span><span class="o">.</span><span class="n">loadPodcasts</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">result</span> <span class="k">in</span>
            <span class="k">let</span> <span class="nv">records</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">value</span> <span class="p">??</span> <span class="p">[]</span>
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">podcasts</span><span class="o">.</span><span class="nf">accept</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>As you can see, we provided the ViewModel with access to the networking layer through a reference to <code class="language-plaintext highlighter-rouge">PodcastsService</code>.</p>

<p>The array of <code class="language-plaintext highlighter-rouge">Podcast</code> records is initially empty, but <code class="language-plaintext highlighter-rouge">loadPodcasts()</code> function allows the user of the ViewModel to query the podcasts at the right time, and as the request completes it updates the list of podcasts.</p>

<h3 id="view">View</h3>

<p>A simple TableViewCell for displaying the Podcast info:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">PodcastCell</span><span class="p">:</span> <span class="kt">UITableViewCell</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">populate</span><span class="p">(</span><span class="nv">podcast</span><span class="p">:</span> <span class="kt">Podcast</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">textLabel</span><span class="p">?</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">podcast</span><span class="o">.</span><span class="n">title</span>
        <span class="n">imageView</span><span class="p">?</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">podcast</span><span class="o">.</span><span class="n">previewImage</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>And finally the ViewController that shows the list of podcasts:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">PodcastsViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>

    <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="o">!</span>
    <span class="k">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="kt">PodcastsViewModel</span><span class="o">!</span>
    <span class="k">var</span> <span class="nv">disposeBag</span> <span class="o">=</span> <span class="kt">DisposeBag</span><span class="p">()</span>
    
    <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        <span class="k">let</span> <span class="nv">cellIdentifier</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="nv">describing</span><span class="p">:</span> <span class="kt">PodcastCell</span><span class="o">.</span><span class="k">self</span><span class="p">)</span>
        <span class="n">tableView</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="kt">PodcastCell</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">forCellReuseIdentifier</span><span class="p">:</span> <span class="n">cellIdentifier</span><span class="p">)</span>
        <span class="n">viewModel</span><span class="o">.</span><span class="n">podcasts</span>
            <span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">tableView</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="nf">items</span><span class="p">(</span><span class="nv">cellIdentifier</span><span class="p">:</span> <span class="n">cellIdentifier</span><span class="p">,</span> <span class="nv">cellType</span><span class="p">:</span> <span class="kt">PodcastCell</span><span class="o">.</span><span class="k">self</span><span class="p">))</span> <span class="p">{</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span> <span class="k">in</span>
                <span class="n">cell</span><span class="o">.</span><span class="nf">populate</span><span class="p">(</span><span class="nv">podcast</span><span class="p">:</span> <span class="n">podcast</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
        <span class="n">viewModel</span><span class="o">.</span><span class="nf">loadPodcasts</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Considering that the <code class="language-plaintext highlighter-rouge">viewModel</code> is instantiated and injected to the <code class="language-plaintext highlighter-rouge">ViewController</code> from the outside, now we have a fully functioning <code class="language-plaintext highlighter-rouge">MVVM</code> module that automatically loads and displays the list of podcasts.</p>

<p>The only problem is that the app is currently not user-friendly. It doesn’t have an indicator for the loading process; neither does it show an error that can possibly occur in the networking layer.</p>

<p>Let’s update the ViewModel to address the challenge:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">PodcastsViewModel</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">PodcastsService</span>
    
    <span class="k">let</span> <span class="nv">podcasts</span> <span class="o">=</span> <span class="kt">BehaviorRelay</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Podcast</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="p">[])</span>
<span class="err">﹢</span>  <span class="k">let</span> <span class="nv">isLoading</span> <span class="o">=</span> <span class="kt">BehaviorRelay</span><span class="o">&lt;</span><span class="kt">Bool</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="err">﹢</span>  <span class="k">let</span> <span class="nv">onError</span> <span class="o">=</span> <span class="kt">PublishRelay</span><span class="o">&lt;</span><span class="kt">Error</span><span class="o">&gt;</span> <span class="o">=</span> <span class="kt">PublishRelay</span><span class="p">()</span>
    
    <span class="kd">func</span> <span class="nf">loadPodcasts</span><span class="p">()</span> <span class="p">{</span>
<span class="err">﹢</span>      <span class="n">isLoading</span><span class="o">.</span><span class="nf">accept</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
        <span class="n">service</span><span class="o">.</span><span class="n">loadPodcasts</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">result</span> <span class="k">in</span>
<span class="err">﹢</span>          <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">isLoading</span><span class="o">.</span><span class="nf">accept</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="err">﹢</span>          <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="p">{</span>
<span class="err">﹢</span>              <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">onError</span><span class="o">.</span><span class="nf">accept</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="err">﹢</span>          <span class="p">}</span>
            <span class="k">let</span> <span class="nv">records</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">value</span> <span class="p">??</span> <span class="p">[]</span>
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">podcasts</span><span class="o">.</span><span class="nf">accept</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>We’ve added <code class="language-plaintext highlighter-rouge">isLoading</code> boolean property for tracking the loading status, and a <code class="language-plaintext highlighter-rouge">onError</code> PublishRelay for reporting an error.</p>

<p>Now we need to update the UI and bind it with the status updates:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">PodcastsViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>

    <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="o">!</span>
<span class="err">﹢</span>  <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">errorMessageLabel</span><span class="p">:</span> <span class="kt">UILabel</span><span class="o">!</span>
<span class="err">﹢</span>  <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">indicatorView</span><span class="p">:</span> <span class="kt">UIActivityIndicatorView</span><span class="o">!</span>
    <span class="k">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="kt">PodcastsViewModel</span><span class="o">!</span>
    <span class="k">var</span> <span class="nv">disposeBag</span> <span class="o">=</span> <span class="kt">DisposeBag</span><span class="p">()</span>
    
    <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        <span class="c1">// ...</span>
<span class="err">﹢</span>      <span class="n">viewModel</span><span class="o">.</span><span class="n">isLoading</span><span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">indicatorView</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">isAnimating</span><span class="p">)</span><span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
<span class="err">﹢</span>      <span class="n">viewModel</span><span class="o">.</span><span class="n">onError</span><span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nv">onNext</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">error</span> <span class="k">in</span>
<span class="err">﹢</span>          <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">errorMessageLabel</span><span class="p">?</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span>
<span class="err">﹢</span>      <span class="p">})</span><span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
<span class="err">﹢</span>      <span class="n">viewModel</span><span class="o">.</span><span class="n">podcasts</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">}</span>
<span class="err">﹢</span>        <span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">errorMessageLabel</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">isHidden</span><span class="p">)</span><span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>OK, now we’re showing <code class="language-plaintext highlighter-rouge">UIActivityIndicatorView</code> when <code class="language-plaintext highlighter-rouge">viewModel.isLoading</code> reports that the podcasts are loading, and there is a <code class="language-plaintext highlighter-rouge">UILabel</code> for showing errors emitted by <code class="language-plaintext highlighter-rouge">viewModel.onError</code></p>

<p>Note, that in the lines 16-17 we also had to explicitly hide the <code class="language-plaintext highlighter-rouge">errorMessageLabel</code> when <code class="language-plaintext highlighter-rouge">podcasts</code> has any records, because otherwise, the error message would stay on the screen even if the podcasts request succeeds after it initially errored out.</p>

<p>You can already sense a code smell. For such a simple use case we’ve already started fighting the state inconsistency.</p>

<p>Let’s take a deep breath in and out, and think for a minute. What are the possible states that our screen actually can be?</p>

<ol>
  <li>Podcasts have not yet been queried</li>
  <li>Podcasts are being loaded</li>
  <li>Podcasts have failed to load</li>
  <li>Podcasts were loaded successfully</li>
</ol>

<p>That’s right, just <strong>four</strong> cases! The superposition of the state values we have right now (<code class="language-plaintext highlighter-rouge">podcasts</code> being empty or not, <code class="language-plaintext highlighter-rouge">isLoading</code> and <code class="language-plaintext highlighter-rouge">onError</code>) gives us <code class="language-plaintext highlighter-rouge">2*2*2 = 8</code> possible cases. <strong>This state redundancy is the reason why we had to implement a fix for conflicting values of <code class="language-plaintext highlighter-rouge">podcasts</code> and <code class="language-plaintext highlighter-rouge">onError</code></strong>. In fact, this means there are other combinations we didn’t consider yet, which can lead to unwanted effects, such as simultaneous display of the <em>error message</em> and the <em>loading indicator</em>.</p>

<p>As we’ve identified the problem, we can refactor the current implementation to purge the state redundancy by introducing <code class="language-plaintext highlighter-rouge">enum</code> with those four cases:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kd">enum</span> <span class="kt">Loadable</span><span class="o">&lt;</span><span class="kt">Value</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">notRequested</span>
    <span class="k">case</span> <span class="n">isLoading</span>
    <span class="k">case</span> <span class="nf">loaded</span><span class="p">(</span><span class="kt">Value</span><span class="p">)</span>
    <span class="k">case</span> <span class="nf">failed</span><span class="p">(</span><span class="kt">Error</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This neat <code class="language-plaintext highlighter-rouge">enum</code> allows us to rework the <code class="language-plaintext highlighter-rouge">ViewModel</code> in the following way:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">PodcastsViewModel</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">PodcastsService</span>
    
    <span class="k">let</span> <span class="nv">podcasts</span> <span class="o">=</span> <span class="kt">BehaviorRelay</span><span class="o">&lt;</span><span class="kt">Loadable</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Podcast</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="o">.</span><span class="n">notRequested</span><span class="p">)</span>
    
    <span class="kd">func</span> <span class="nf">loadPodcasts</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">podcasts</span><span class="o">.</span><span class="nf">accept</span><span class="p">(</span><span class="o">.</span><span class="n">isLoading</span><span class="p">)</span>
        <span class="n">service</span><span class="o">.</span><span class="n">loadPodcasts</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">result</span> <span class="k">in</span>
            <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
            <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">podcasts</span><span class="o">.</span><span class="nf">accept</span><span class="p">(</span><span class="o">.</span><span class="nf">loaded</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
                <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">podcasts</span><span class="o">.</span><span class="nf">accept</span><span class="p">(</span><span class="o">.</span><span class="nf">failed</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>With just one variable we were able to represent all the states we had, but now – without the state redundancy.</p>

<p>Refactoring the ViewController:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">PodcastsViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>

    <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="o">!</span>
    <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">errorMessageLabel</span><span class="p">:</span> <span class="kt">UILabel</span><span class="o">!</span>
    <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">indicatorView</span><span class="p">:</span> <span class="kt">UIActivityIndicatorView</span><span class="o">!</span>
    <span class="k">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="kt">PodcastsViewModel</span><span class="o">!</span>
    <span class="k">var</span> <span class="nv">disposeBag</span> <span class="o">=</span> <span class="kt">DisposeBag</span><span class="p">()</span>
    
    <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        <span class="c1">// ...</span>
<span class="err">﹢</span>      <span class="n">viewModel</span><span class="o">.</span><span class="n">podcasts</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">isLoading</span> <span class="p">}</span>
            <span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">indicatorView</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">isAnimating</span><span class="p">)</span><span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
<span class="err">﹢</span>      <span class="n">viewModel</span><span class="o">.</span><span class="n">podcasts</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">error</span><span class="p">?</span><span class="o">.</span><span class="n">localizedDescription</span> <span class="p">}</span>
            <span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">errorMessageLabel</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
<span class="err">﹢</span>      <span class="n">viewModel</span><span class="o">.</span><span class="n">podcasts</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="p">??</span> <span class="p">[]</span> <span class="p">}</span>
            <span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">tableView</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="nf">items</span><span class="p">(</span><span class="nv">cellIdentifier</span><span class="p">:</span> <span class="n">cellIdentifier</span><span class="p">,</span> <span class="nv">cellType</span><span class="p">:</span> <span class="kt">PodcastCell</span><span class="o">.</span><span class="k">self</span><span class="p">))</span> <span class="p">{</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span> <span class="k">in</span>
                <span class="n">cell</span><span class="o">.</span><span class="nf">populate</span><span class="p">(</span><span class="nv">podcast</span><span class="p">:</span> <span class="n">podcast</span><span class="p">)</span>
            <span class="p">}</span><span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>For convenient mapping the <code class="language-plaintext highlighter-rouge">Loadable&lt;[Podcast]&gt;</code> in the code above we can use an extension for the <code class="language-plaintext highlighter-rouge">Loadable</code>:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">Loadable</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">isLoading</span><span class="p">:</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">isLoading</span><span class="p">:</span> <span class="k">return</span> <span class="kc">true</span>
        <span class="k">default</span><span class="p">:</span> <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">var</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Value</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
        <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">loaded</span><span class="p">(</span><span class="n">value</span><span class="p">):</span> <span class="k">return</span> <span class="n">value</span>
        <span class="k">default</span><span class="p">:</span> <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">var</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
        <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">failed</span><span class="p">(</span><span class="n">error</span><span class="p">):</span> <span class="k">return</span> <span class="n">error</span>
        <span class="k">default</span><span class="p">:</span> <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Great! Now our state - UI binding is much more clear and doesn’t require an excessive code for fixing visual defects.</p>

<p>If we want to display the previously loaded list while performing the list refresh, we can extend the <code class="language-plaintext highlighter-rouge">isLoading</code> case with a parameter for holding the value.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kd">enum</span> <span class="kt">Loadable</span><span class="o">&lt;</span><span class="kt">Value</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">notRequested</span>
<span class="err">﹢</span>  <span class="k">case</span> <span class="nf">isLoading</span><span class="p">(</span><span class="nv">prevValue</span><span class="p">:</span> <span class="kt">Value</span><span class="p">?)</span>
    <span class="k">case</span> <span class="nf">loaded</span><span class="p">(</span><span class="kt">Value</span><span class="p">)</span>
    <span class="k">case</span> <span class="nf">failed</span><span class="p">(</span><span class="kt">Error</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Loadable</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Value</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
        <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">loaded</span><span class="p">(</span><span class="n">value</span><span class="p">):</span> <span class="k">return</span> <span class="n">value</span>
<span class="err">﹢</span>      <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">isLoading</span><span class="p">(</span><span class="n">prevValue</span><span class="p">):</span> <span class="k">return</span> <span class="n">prevValue</span>
        <span class="k">default</span><span class="p">:</span> <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The final implementation of the <code class="language-plaintext highlighter-rouge">Loadable</code>, as well as a few more perks for it can be found in the <a href="https://gist.github.com/nalexn/df65131de76301130c8e179d02cec939">gist on Github</a>; however, this was just an example of how to improve the clarity and stability of the reactive code by eliminating the state redundancy in the ViewModel.</p>

      <h2>Your appreciation is my inspiration!</h2>
      <p>I have tons of unpublished kick-ass materials and ideas, but I need your help! Consider sharing this article on <a href="https://twitter.com/share?url=http://nalexn.github.io/mvvm-state-redundancy/?utm_source=share_tw&amp;text=Fighting state redundancy in Model-View-ViewModel&amp;hashtags=iosdev&amp;via=nallexn" title="Twitter" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-twitter share-button"></i></a>, <a href="https://www.facebook.com/sharer/sharer.php?u=http://nalexn.github.io/mvvm-state-redundancy/?utm_source=share_fb&amp;display=popup&amp;quote=Fighting state redundancy in Model-View-ViewModel&amp;hashtag=#iosdev" title="Facebook" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-facebook-f share-button"></i></a> or <a href="https://www.linkedin.com/sharing/share-offsite/?url=http://nalexn.github.io/mvvm-state-redundancy/?utm_source=share_in" title="LinkedIn" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=500');return false;"><i class="fa fa-linkedin share-button"></i></a>. This tiny action helps to grow this blog and inspires me to post more! (Or if you are nuts, <a href="https://venmo.com/nallexn" target="_blank">Venmo</a> me a drink!)</p>
      </p>
      <p>You can subscribe to <a href="http://nalexn.github.io/feed.xml" target="_blank">RSS feed</a> or follow my <a href="https://twitter.com/nallexn" target="_blank">Twitter</a> for the new articles alerts.

      <div style="width:0px; height:30px; display: block;"></div>
      <h2>Most recent articles</h2>
      <div class="content-box recent clearfix" style="padding: 20px 10px;">
        
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/layers_001.jpg)" href="/separation-of-concerns/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/separation-of-concerns/">Separation of Concerns in Software Design</a></h2>
              <p></p>
              <span class="post-date">2020, Jan 16&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">10 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/observable_001.jpg)" href="/swiftui-observableobject/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/swiftui-observableobject/">Why I quit using the ObservableObject</a></h2>
              <p></p>
              <span class="post-date">2019, Dec 20&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">7 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/comparison_01.jpg)" href="/anyview-vs-group/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/anyview-vs-group/">Performance Battle: AnyView vs Group</a></h2>
              <p></p>
              <span class="post-date">2019, Dec 05&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">9 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/swiftui_unit_testing_01.jpg)" href="/swiftui-unit-testing/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/swiftui-unit-testing/">Who said we cannot unit test SwiftUI views?</a></h2>
              <p></p>
              <span class="post-date">2019, Nov 21&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">12 minute read</span>
            </div>
          </article>
          
        
          
          <article class="post">
            
              <a class="post-thumbnail" style="background-image: url(/assets/img/deep_link_swiftui_01.jpg)" href="/swiftui-deep-linking/"></a>
            
            <div class="post-content">
              <h2 class="post-title"><a href="/swiftui-deep-linking/">Programmatic navigation in SwiftUI project</a></h2>
              <p></p>
              <span class="post-date">2019, Nov 08&nbsp;&nbsp;&nbsp;—&nbsp;</span>
              <span class="post-words">7 minute read</span>
            </div>
          </article>
          
        
        <article class="post">
          <a class="post-thumbnail" style="background-image: url(/assets/img/launch_001.jpg)" href="/"></a>
          <div class="post-content">
            <h2 class="post-title"><a href="/">Browse All Articles</a></h2>
            <p></p>
            <span class="post-date">Top iOS programming stuff, no kidding!</span>
          </div>
        </article>
      </div>
    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
</body>
</html>
